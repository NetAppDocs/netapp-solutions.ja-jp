---
sidebar: sidebar 
permalink: ehc/dr-draas-nfs.html 
keywords: dr, draas, bluexp, disaster recovery, nfs datastore 
summary: このセクションでは、オンプレミスのVMware VMから別の指定されたサイトへのディザスタリカバリを設定するためのBlueXP  DRaaSの構成について説明します。 
---
= BlueXP  データストア向けDRaaSを使用したDR
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
本番用サイトからディザスタリカバリサイトへのブロックレベルのレプリケーションを通じてディザスタリカバリを実装することは、サイトの停止やランサムウェア攻撃などのデータ破損イベントからワークロードを保護するための、耐障害性と対費用効果に優れた方法です。NetApp SnapMirrorレプリケーションを使用すると、オンプレミスのONTAPシステムとNFSデータストアで実行されているVMwareワークロードを、VMwareも導入されている指定のリカバリデータセンターにある別のONTAPストレージシステムにレプリケートできます。

このセクションでは、オンプレミスのVMware VMから別の指定されたサイトへのディザスタリカバリを設定するためのBlueXP  DRaaSの構成について説明します。このセットアップの一環として、BlueXP  アカウントであるBlueXP  ConnectorがBlueXP  ワークスペースに追加されました。これは、VMware vCenterからONTAPストレージへの通信を有効にするために必要なONTAPアレイです。また、サイト間のレプリケーションの設定方法、およびリカバリプランのセットアップとテスト方法についても詳しく説明します。最後のセクションでは、サイト全体のフェイルオーバーを実行する手順と、プライマリサイトがリカバリされてオンラインで購入された場合のフェイルバック方法について説明します。

NetApp BlueXP  コンソールに統合されたBlueXP  ディザスタリカバリサービスを利用すると、オンプレミスのVMware vCenterとONTAPストレージを簡単に検出できます。その後、リソースグループの作成、ディザスタリカバリ計画の作成、リソースグループへの関連付け、フェイルオーバーとフェイルバックのテストまたは実行が可能になります。SnapMirrorは、ストレージレベルのブロックレプリケーションを提供し、増分変更によって2つのサイトを最新の状態に保ちます。その結果、Recovery Point Objective（RPO；目標復旧時点）は最大5分になります。また、本番環境に影響を与えたり、追加のストレージコストをかけたりすることなく、ディザスタリカバリ手順をシミュレートできます。

BlueXP  ディザスタリカバリでは、ONTAPのFlexCloneテクノロジを使用して、ディザスタリカバリサイトで最後にレプリケートされたSnapshotから、スペース効率に優れたNFSデータストアのコピーを作成します。ディザスタリカバリテストが完了すると、レプリケートされた実際の本番リソースに影響を与えることなく、テスト環境を簡単に削除できます。実際にフェイルオーバーが発生した場合は、BlueXP  ディザスタリカバリサービスによって必要なすべての手順が調整され、数回クリックするだけで、指定されたディザスタリカバリサイトで保護対象の仮想マシンが自動的に起動されます。また、SnapMirror関係をプライマリサイトに反転し、必要に応じてフェイルバック処理のためにセカンダリからプライマリに変更をレプリケートします。これらの機能はすべて、他の有名な代替製品と比較して数分の1のコストで提供されます。

image:dr-draas-nfs-image1.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]



== はじめに

BlueXP  ディザスタリカバリを開始するには、BlueXP  コンソールを使用してサービスにアクセスします。

. BlueXPにログインします。
. BlueXP  の左側のナビゲーションで、[Protection]>[Disaster Recovery]を選択します。
. BlueXP  ディザスタリカバリのダッシュボードが表示されます。
+
image:dr-draas-nfs-image2.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]



ディザスタリカバリプランを設定する前に、次の前提条件を満たしていることを確認してください。

* BlueXP  ConnectorはNetApp BlueXP  で設定されます。
* BlueXP  Connectorインスタンスが、ソースおよびデスティネーションのvCenterおよびストレージシステムに接続されている。
* ストレージNFSデータストアを提供するNetApp Data ONTAPクラスタ。
* VMware用のNFSデータストアをホストするオンプレミスのNetAppストレージシステムは、BlueXP  に追加されます。
* DNS名を使用する場合は、DNS解決が実行されている必要があります。それ以外の場合は、vCenterのIPアドレスを使用します。
* 指定したNFSベースのデータストアボリュームに対してSnapMirrorレプリケーションが設定されている。
* サポートされているバージョンのvCenter ServerおよびESXiサーバが環境にあることを確認します。


ソースサイトとデスティネーションサイトの間に接続が確立されたら、設定手順に進みます。数回のクリックで約3~5分かかります。


NOTE: NetAppでは、BlueXP  Connectorがソースリソースとデスティネーションリソースとネットワーク経由で通信できるように、BlueXP  Connectorをデスティネーションサイトまたは3番目のサイトに配置することを推奨しています。

image:dr-draas-nfs-image3.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]



== BlueXP  テイサスタリカハリセツテイ

ディザスタリカバリを準備するための最初のステップは、オンプレミスのvCenterリソースとストレージリソースを検出し、BlueXP  ディザスタリカバリに追加することです。

BlueXP  コンソールを開き、左側のナビゲーションから*[保護]>[ディザスタリカバリ]*を選択します。[Discover vCenter servers（vCenterサーバの検出）]*を選択するか、トップメニューで*[Sites（サイト）]>[Add（追加）]>[Add vCenter（vCenterの追加）]

image:dr-draas-nfs-image4.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

次のプラットフォームを追加します。

* *ソース*。オンプレミスのvCenter：
+
image:dr-draas-nfs-image5.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

* *デスティネーション*。VMC SDDC vCenter：
+
image:dr-draas-nfs-image6.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]



vCenterが追加されると、自動検出がトリガーされます。



== ソースサイトアレイとデスティネーションサイトアレイ間のストレージレプリケーションの設定

SnapMirrorは、NetApp環境でデータレプリケーションを提供します。NetApp Snapshot®テクノロジを基盤とするSnapMirrorレプリケーションは、前回の更新以降に変更または追加されたブロックのみをレプリケートするため、非常に効率的です。SnapMirrorは、NetApp OnCommand®システムマネージャまたはONTAP CLIを使用して簡単に設定できます。クラスタとSVMのピアリングが事前に設定されていれば、BlueXP  DRaaSでもSnapMirror関係が作成されます。

プライマリストレージが完全に失われていない場合は、SnapMirrorを使用してプライマリサイトとDRサイトを効率的に再同期できます。SnapMirrorでは、SnapMirror関係をDRサイトからプライマリサイトに反転させるだけで、変更されたデータや新規のデータのみを転送して、2つのサイトを再同期できます。つまり、BlueXP  DRaaSのレプリケーション計画は、ボリューム全体を再コピーすることなく、フェイルオーバー後にどちらの方向にも再同期できます。関係を逆方向に再同期すると、Snapshotコピーの前回の同期以降に書き込まれた新しいデータだけがデスティネーションに送信されます。


NOTE: CLIまたはSystem Managerを使用してボリュームに対してSnapMirror関係がすでに設定されている場合、BlueXP  DRaaSは関係をピックアップし、残りのワークフロー処理を続行します。



== VMwareディザスタリカバリ用のセットアップ方法

SnapMirrorレプリケーションの作成プロセスは、どのアプリケーションでも同じです。プロセスは手動でも自動でもかまいません。最も簡単な方法は、BlueXP  を活用してSnapMirrorレプリケーションを設定する方法です。環境内のソースONTAPシステムをデスティネーションにドラッグアンドドロップするだけで、残りのプロセスをウィザードで実行できます。

image:dr-draas-nfs-image7.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

BlueXP  DRaaSでは、次の2つの基準が満たされていれば、同じことを自動化することもできます。

* ソースクラスタとデスティネーションクラスタにピア関係が確立されています。
* ソースSVMとデスティネーションSVMのピア関係が確立されています。
+
image:dr-draas-nfs-image8.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]




NOTE: CLIを使用してボリュームに対してSnapMirror関係がすでに設定されている場合、BlueXP  DRaaSは関係をピックアップし、残りのワークフロー操作を続行します。



== BlueXP  ディザスタリカバリにはどのようなメリットがありますか？

ソースサイトとデスティネーションサイトが追加されると、BlueXP  ディザスタリカバリによって詳細な自動検出が実行され、VMと関連するメタデータが表示されます。BlueXP  ディザスタリカバリでは、VMで使用されているネットワークとポートグループも自動的に検出されて読み込まれます。

image:dr-draas-nfs-image9.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

サイトを追加したら、VMをリソースグループにグループ化できます。BlueXP  ディザスタリカバリリソースグループを使用すると、依存するVMのセットを論理グループにグループ化できます。論理グループには、リカバリ時に実行できるブート順序とブート遅延が含まれます。リソースグループの作成を開始するには、*[リソースグループ]*に移動し、*[新しいリソースグループの作成]*をクリックします。

image:dr-draas-nfs-image10.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

image:dr-draas-nfs-image11.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: リソースグループは、レプリケーション計画の作成時に作成することもできます。

シンプルなドラッグアンドドロップメカニズムを使用して、リソースグループの作成時にVMのブート順序を定義または変更できます。

image:dr-draas-nfs-image12.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

リソースグループを作成したら、次のステップでは、災害発生時に仮想マシンとアプリケーションをリカバリするための実行計画または計画を作成します。前提条件で説明したように、SnapMirrorレプリケーションは事前に構成することも、DRaaSはレプリケーション計画の作成時に指定したRPOと保持数を使用して構成することもできます。

image:dr-draas-nfs-image13.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

image:dr-draas-nfs-image14.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

レプリケーション計画を設定するには、ドロップダウンからソースとデスティネーションのvCenterプラットフォームを選択し、計画に含めるリソースグループを選択します。また、アプリケーションのリストア方法と電源投入方法のグループ化、クラスタとネットワークのマッピングも選択します。リカバリプランを定義するには、*[レプリケーションプラン]*タブに移動し、*[プランの追加]*をクリックします。

最初にソースvCenterを選択し、次にデスティネーションvCenterを選択します。

image:dr-draas-nfs-image15.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

次の手順では、既存のリソースグループを選択します。リソースグループが作成されていない場合は、ウィザードを使用して、リカバリ目標に基づいて必要な仮想マシンをグループ化（基本的に機能的なリソースグループを作成）できます。これは、アプリケーション仮想マシンのリストア方法のオペレーションシーケンスの定義にも役立ちます。

image:dr-draas-nfs-image16.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: リソースグループでは'ドラッグアンドドロップ機能を使用してブート順序を設定できますこれを使用すると、リカバリプロセス中にVMの電源をオンにする順序を簡単に変更できます。


NOTE: リソースグループ内の各仮想マシンは、順序に基づいて順番に起動されます。2つのリソースグループが並行して開始されます。

以下のスクリーンショットは、リソースグループを事前に作成していない場合に、組織の要件に基づいて仮想マシンまたは特定のデータストアをフィルタリングするオプションを示しています。

image:dr-draas-nfs-image17.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

リソースグループを選択したら、フェイルオーバーマッピングを作成します。この手順では、ソース環境のリソースをデスティネーションにマッピングする方法を指定します。これには、コンピューティングリソースや仮想ネットワークが含まれます。IPカスタマイズ、プリスクリプトとポストスクリプト、ブート遅延、アプリケーションの整合性など。詳細については、を参照してくださいlink:https://docs.netapp.com/us-en/bluexp-disaster-recovery/use/drplan-create.html#select-applications-to-replicate-and-assign-resource-groups["レプリケーション計画の作成"]。

image:dr-draas-nfs-image18.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: デフォルトでは、テスト処理とフェイルオーバー処理の両方に同じマッピングパラメータが使用されます。テスト環境に異なるマッピングを設定するには、次のようにチェックボックスをオフにしてから[Test mapping]オプションを選択します。

image:dr-draas-nfs-image19.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

リソースのマッピングが完了したら、[Next]をクリックします。

image:dr-draas-nfs-image20.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

繰り返しタイプを選択します。簡単に言えば、[Migrate]（フェイルオーバーを使用した1回限りの移行）または[Recurring Continuous Replication]オプションを選択します。このチュートリアルでは、[複製]オプションが選択されています。

image:dr-draas-nfs-image21.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

完了したら、作成したマッピングを確認し、*[プランの追加]*をクリックします。


NOTE: 異なるボリュームやSVMのVMをレプリケーションプランに含めることができます。VMの配置（同じボリュームまたは同じSVM内の別 々 のボリューム、異なるSVM上の別 々 のボリューム）に応じて、BlueXP  ディザスタリカバリでは整合グループSnapshotが作成されます。

image:dr-draas-nfs-image22.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

image:dr-draas-nfs-image23.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

BlueXP  DRaaSは次のワークフローで構成されています。

* テストフェイルオーバー（定期的な自動シミュレーションを含む）
* フェイルオーバーテストのクリーンアップ
* フェイルオーバー
* フェイルバック




== テストフェイルオーバー

BlueXP  でのテストフェイルオーバーDRaaSは、VMware管理者が本番環境を中断することなくリカバリプランを完全に検証できるようにするための運用手順です。

image:dr-draas-nfs-image24.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

BlueXP  DRaaSには、テストフェイルオーバー処理のオプション機能としてスナップショットを選択する機能が組み込まれています。この機能により、VMware管理者は、環境で最近行われた変更がデスティネーションサイトにレプリケートされ、テスト中に存在することを確認できます。このような変更には、VMゲストオペレーティングシステムへのパッチなどが含まれます。

image:dr-draas-nfs-image25.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

VMware管理者がテストフェイルオーバー処理を実行すると、BlueXP  DRaaSによって次のタスクが自動化されます。

* SnapMirror関係をトリガーして、本番用サイトで最近行われた変更を使用してデスティネーションサイトのストレージを更新します。
* DRストレージアレイにFlexVolボリュームのNetApp FlexCloneボリュームを作成します。
* FlexCloneボリューム内のNFSデータストアをDRサイトのESXiホストに接続します。
* VMネットワークアダプタを、マッピング時に指定したテストネットワークに接続します。
* DRサイトのネットワークに対して定義されているVMゲストオペレーティングシステムのネットワーク設定を再設定します。
* レプリケーションプランに保存されているカスタムコマンドを実行します。
* レプリケーション計画に定義されている順序でVMの電源をオンにします。
+
image:dr-draas-nfs-image26.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]





== フェイルオーバーテスト処理のクリーンアップ

フェイルオーバーテストのクリーンアップ処理は、レプリケーションプランテストが完了し、VMware管理者がクリーンアッププロンプトに応答したあとに実行されます。

image:dr-draas-nfs-image27.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

この操作により、仮想マシン（VM）とレプリケーションプランのステータスがREADY状態にリセットされます。

VMware管理者がリカバリ操作を実行すると、BlueXP  DRaaSは次のプロセスを実行します。

. テストに使用したFlexCloneコピー内のリカバリされた各VMの電源がオフになります。
. テスト中にリカバリされたVMの提供に使用したFlexCloneボリュームが削除されます。




== 計画的な移行とフェイルオーバー

BlueXP  DRaaSには、実際のフェイルオーバーを実行するための2つの方法があります。計画的移行とフェイルオーバーです。最初の方法である計画的移行では、VMのシャットダウンとストレージレプリケーションの同期をプロセスに組み込み、VMをリカバリしたり、デスティネーションサイトに効果的に移動したりします。移行を計画的に行うには、移行元サイトへのアクセスが必要です。2つ目の方法であるフェイルオーバーは、計画的/計画外フェイルオーバーです。デスティネーションサイトで、最後にストレージのレプリケーションが完了した時点からVMをリカバリします。ソリューションに設計されたRPOによっては、DRシナリオである程度のデータ損失が予想されます。

image:dr-draas-nfs-image28.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

VMware管理者がフェイルオーバー処理を実行すると、BlueXP  DRaaSによって次のタスクが自動化されます。

* NetApp SnapMirror関係を解除してフェイルオーバーする。
* レプリケートされたNFSデータストアをDRサイトのESXiホストに接続します。
* VMネットワークアダプタを適切なデスティネーションサイトネットワークに接続します。
* デスティネーションサイトのネットワークに対して定義されているように、VMゲストオペレーティングシステムのネットワーク設定を再構成します。
* レプリケーションプランに保存されているカスタムコマンド（存在する場合）を実行します。
* レプリケーション計画で定義された順序でVMの電源をオンにします。


image:dr-draas-nfs-image29.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]



== フェイルバック

フェイルバックは、リカバリ後にソースサイトとデスティネーションサイトの元の構成をリストアするオプションの手順です。

image:dr-draas-nfs-image30.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

VMware管理者は、元のソースサイトにサービスをリストアする準備ができたら、フェイルバック手順を構成して実行できます。

*注：* BlueXP  DRaaSは、レプリケーション方向を反転する前に、変更を元のソース仮想マシンに複製（再同期）します。このプロセスは、ターゲットへのフェイルオーバーが完了した関係から開始し、次の手順を実行します。

* デスティネーションサイトの仮想マシンとボリュームの電源をオフにして登録解除します。
* 元のソースのSnapMirror関係を解除して読み取り/書き込み可能にします。
* SnapMirror関係を再同期してレプリケーションを反転します。
* ソースにボリュームをマウントし、電源をオンにしてソース仮想マシンを登録します。


BlueXP  DRaaSへのアクセスと設定の詳細については、を参照してくださいlink:https://docs.netapp.com/us-en/bluexp-disaster-recovery/get-started/dr-intro.html["BlueXP  for VMwareのディザスタリカバリの詳細"]。



== 監視とダッシュボード

BlueXP  またはONTAP CLIから、該当するデータストアボリュームのレプリケーションヘルスステータスを監視できます。また、フェイルオーバーまたはテストフェイルオーバーのステータスは、ジョブ監視を使用して追跡できます。

image:dr-draas-nfs-image31.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: 進行中またはキューに登録されているジョブを停止する場合は、キャンセルすることもできます。

BlueXP  のディザスタリカバリダッシュボードを使用して、ディザスタリカバリサイトとレプリケーション計画のステータスを確実に評価できます。これにより、正常なサイト、切断されているサイト、パフォーマンスが低下しているサイトや計画を迅速に特定できます。

image:dr-draas-nfs-image32.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

これにより、カスタマイズされたディザスタリカバリ計画を処理するための強力なソリューションが提供されます。フェイルオーバーは、計画的フェイルオーバーまたはフェイルオーバーとして実行できます。災害発生時にDRサイトのアクティブ化が決定した場合は、ボタンをクリックするだけで実行できます。

このプロセスの詳細については、詳細なウォークスルービデオに従うか、を使用してくださいlink:https://netapp.github.io/bluexp-draas-simulator/?frame-1["ソリューションシミュレータ"]。
