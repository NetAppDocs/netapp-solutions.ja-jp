---
sidebar: sidebar 
permalink: ehc/aws/aws-guest-dr-config-snapmirror.html 
keywords: Intercluster logical interfaces, cluster peering, SVM peering, snapshot retention policy, destination volumes, SnapMirror relationships 
summary: SnapCenter では、長期のアーカイブと保持を目的として、プライマリストレージシステム（primary > mirror）およびセカンダリストレージシステム（primary > vault）内のSnapMirror関係を更新できます。そのためには、SnapMirrorを使用して、デスティネーションボリュームとソースボリューム間のデータレプリケーション関係を確立して初期化する必要があります。 
---
= SnapMirror関係と保持スケジュールを設定
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../../media/


link:aws-guest-dr-snapcenter-overview.html["Previous：Overview：災害復旧"]

SnapCenter では、長期のアーカイブと保持を目的として、プライマリストレージシステム（primary > mirror）およびセカンダリストレージシステム（primary > vault）内のSnapMirror関係を更新できます。そのためには、SnapMirrorを使用して、デスティネーションボリュームとソースボリューム間のデータレプリケーション関係を確立して初期化する必要があります。

ソースとデスティネーションのONTAP システムが、Amazon VPCピアリング、トランジットゲートウェイ、AWS Direct Connect、またはAWS VPNを使用してピア関係にあるネットワークに配置されている必要があります。

オンプレミスのONTAP システムとFSX ONTAP 間にSnapMirror関係を設定するには、次の手順を実行する必要があります。

* ソースとデスティネーションのクラスタ間論理インターフェイスを記録します。
* ONTAP とFSXの間にクラスタピアリングを確立します。
* SVMピア関係を確立する。
* Snapshot保持ポリシーを作成します。
* FSXにデスティネーションボリュームを作成します。
* ソースボリュームとデスティネーションボリューム間にSnapMirror関係を作成します。
* SnapMirror関係を初期化


を参照してください https://docs.aws.amazon.com/fsx/latest/ONTAPGuide/ONTAPGuide.pdf["FSX for ONTAP –ONTAP ユーザーガイド"^] FSXを使用したSnapMirror関係の作成の詳細については、を参照してください。



== ソースとデスティネーションのクラスタ間論理インターフェイスを記録します

オンプレミスにあるソースONTAP システムの場合、クラスタ間LIFの情報をSystem ManagerまたはCLIから取得できます。

. ONTAP System Managerで、ネットワークの概要ページに移動し、タイプ：クラスタ間のIPアドレスを取得します。このIPアドレスは、FSXがインストールされているAWS VPCと通信するように設定されています。
+
image:dr-vmc-aws-image10.png["エラー：グラフィックイメージがありません"]

. FSXのクラスタ間IPアドレスを取得するには、CLIにログインして次のコマンドを実行します。
+
....
FSx-Dest::> network interface show -role intercluster
....
+
image:dr-vmc-aws-image11.png["エラー：グラフィックイメージがありません"]





== ONTAP とFSXの間にクラスタピアリングを確立します

ONTAP クラスタ間のクラスタピアリングを確立するには、開始側のONTAP クラスタで入力した一意のパスフレーズを、もう一方のピアクラスタで確認する必要があります。

. デスティネーションFSXクラスタ上で' cluster peer createコマンドを使用してピアリングを設定しますプロンプトが表示されたら、あとでソースクラスタで使用する一意のパスフレーズを入力して作成プロセスを完了します。
+
....
FSx-Dest::> cluster peer create -address-family ipv4 -peer-addrs source_intercluster_1, source_intercluster_2
Enter the passphrase:
Confirm the passphrase:
....
. ソースクラスタでは、ONTAP System ManagerまたはCLIを使用してクラスタピア関係を確立できます。ONTAP System Managerで、Protection > Overviewの順に選択し、Peer Clusterを選択します。
+
image:dr-vmc-aws-image12.png["エラー：グラフィックイメージがありません"]

. Peer Cluster（ピアクラスタ）ダイアログボックスで、必要な情報を入力します。
+
.. デスティネーションFSXクラスタでピアクラスタ関係を確立するために使用したパスフレーズを入力します。
.. [はい]を選択して'暗号化された関係を確立します
.. デスティネーションFSXクラスタのクラスタ間LIFのIPアドレスを入力します。
.. クラスタピアリングの開始をクリックしてプロセスを完了します。
+
image:dr-vmc-aws-image13.png["エラー：グラフィックイメージがありません"]



. 次のコマンドを使用して、FSXクラスタからクラスタピア関係のステータスを確認します。
+
....
FSx-Dest::> cluster peer show
....
+
image:dr-vmc-aws-image14.png["エラー：グラフィックイメージがありません"]





== SVMピア関係を確立する

次の手順では、SnapMirror関係にあるボリュームを含むデスティネーションとソースのStorage Virtual Machineの間にSVM関係をセットアップします。

. ソースFSXクラスタから、CLIから次のコマンドを使用して、SVMピア関係を作成します。
+
....
FSx-Dest::> vserver peer create -vserver DestSVM -peer-vserver Backup -peer-cluster OnPremSourceSVM -applications snapmirror
....
. ソースONTAP クラスタで、ONTAP System ManagerまたはCLIのいずれかを使用してピアリング関係を承認します。
. ONTAP System Managerで、保護>概要に移動し、Storage VMピアの下にあるピアStorage VMを選択します。
+
image:dr-vmc-aws-image15.png["エラー：グラフィックイメージがありません"]

. Peer Storage VMダイアログボックスで、次のフィールドに入力します。
+
** ソースStorage VM
** デスティネーションクラスタ
** デスティネーションStorage VM
+
image:dr-vmc-aws-image16.png["エラー：グラフィックイメージがありません"]



. [Peer Storage VMs]をクリックして、SVMピアリングプロセスを完了します。




== Snapshot保持ポリシーを作成します

SnapCenter は、プライマリストレージシステムにSnapshotコピーとして存在するバックアップの保持スケジュールを管理します。これは、SnapCenter でポリシーを作成するときに確立されます。SnapCenter では、セカンダリストレージシステムに保持されるバックアップの保持ポリシーは管理されません。これらのポリシーは、セカンダリFSXクラスタで作成されたSnapMirrorポリシーを使用して個別に管理され、ソースボリュームとSnapMirror関係にあるデスティネーションボリュームに関連付けられます。

SnapCenter ポリシーを作成するときに、SnapCenter バックアップの作成時に生成される各SnapshotのSnapMirrorラベルに追加するセカンダリポリシーラベルを指定できます。


NOTE: セカンダリストレージでは、Snapshotを保持するために、これらのラベルがデスティネーションボリュームに関連付けられたポリシールールと照合されます。

次の例は、SQL Serverデータベースおよびログボリュームの日次バックアップに使用するポリシーの一部として生成されたすべてのSnapshotに適用されるSnapMirrorラベルを示しています。

image:dr-vmc-aws-image17.png["エラー：グラフィックイメージがありません"]

SQL ServerデータベースのSnapCenter ポリシーの作成の詳細については、を参照してください https://docs.netapp.com/us-en/snapcenter/protect-scsql/task_create_backup_policies_for_sql_server_databases.html["SnapCenter のドキュメント"^]。

まず、保持するSnapshotコピーの数にルールを指定してSnapMirrorポリシーを作成する必要があります。

. FSXクラスタ上にSnapMirrorポリシーを作成します。
+
....
FSx-Dest::> snapmirror policy create -vserver DestSVM -policy PolicyName -type mirror-vault -restart always
....
. SnapCenter ポリシーで指定されたセカンダリポリシーラベルと一致するSnapMirrorラベルを持つルールをポリシーに追加します。
+
....
FSx-Dest::> snapmirror policy add-rule -vserver DestSVM -policy PolicyName -snapmirror-label SnapMirrorLabelName -keep #ofSnapshotsToRetain
....
+
次のスクリプトは、ポリシーに追加できるルールの例を示しています。

+
....
FSx-Dest::> snapmirror policy add-rule -vserver sql_svm_dest -policy Async_SnapCenter_SQL -snapmirror-label sql-ondemand -keep 15
....
+

NOTE: SnapMirrorラベルごとに追加のルールを作成し、保持するSnapshotの数（保持期間）を指定します。





== デスティネーションボリュームを作成

ソースボリュームからSnapshotコピーの受信者となるデスティネーションボリュームをFSX上に作成するには、FSX ONTAP 上で次のコマンドを実行します。

....
FSx-Dest::> volume create -vserver DestSVM -volume DestVolName -aggregate DestAggrName -size VolSize -type DP
....


== ソースボリュームとデスティネーションボリューム間にSnapMirror関係を作成します

ソースボリュームとデスティネーションボリューム間のSnapMirror関係を作成するには、FSX ONTAP で次のコマンドを実行します。

....
FSx-Dest::> snapmirror create -source-path OnPremSourceSVM:OnPremSourceVol -destination-path DestSVM:DestVol -type XDP -policy PolicyName
....


== SnapMirror関係を初期化

SnapMirror関係を初期化このプロセスにより、ソースボリュームから生成された新しいSnapshotが開始され、デスティネーションボリュームにコピーされます。

ボリュームを作成するには、FSX ONTAP で次のコマンドを実行します。

....
FSx-Dest::> volume create -vserver DestSVM -volume DestVolName -aggregate DestAggrName -size VolSize -type DP
....
link:aws-guest-dr-config-snapcenter.html["次に、オンプレミスにWindows SnapCenter サーバを導入して設定します。"]
