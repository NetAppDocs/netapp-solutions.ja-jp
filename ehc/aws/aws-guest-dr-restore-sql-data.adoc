---
sidebar: sidebar 
permalink: ehc/aws/aws-guest-dr-restore-sql-data.html 
keywords: Configure, FSx storage, SQL Server, restore, Windows VM, iSCSI access, file systems, SnapCenter, SQL Server Plug-in 
summary: このページでは、オンプレミスサイトが動作不能になった場合に、VMwareクラウド サービス でAWSのSQL Serverをリカバリする方法について説明します。 
---
= SQL Serverアプリケーションデータをリストアする
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../../media/


link:aws-guest-dr-restore-veeam-full.html["前のバージョン：アプリケーションVMをVeeamフルリストアとリストア"]

次のプロセスでは、オンプレミスサイトが動作不能になった場合に、VMwareクラウド サービス でAWS内のSQL Serverをリカバリする方法について説明します。

リカバリ手順を続行するには、次の前提条件を満たしている必要があります。

. Windows Server VMがVeeam Full Restoreを使用してVMware Cloud SDDCにリストアされている。
. セカンダリSnapCenter サーバが確立され、セクションで説明する手順に従ってSnapCenter データベースのリストアと設定が完了している link:aws-guest-dr-snapcenter-db-backup.html#snapcenter-backup-and-restore-process-summary["SnapCenter のバックアップとリストアのプロセスの概要"]


SQL Serverアプリケーションデータのリカバリプロセスの概要は次のとおりです。

. リストアプロセスに備えてVMを設定します。
. iSCSIアクセス用にFSXをセットアップします。
. Windows VMでiSCSIアクセスをセットアップ
. SQL Serverデータベースを接続し、オンラインにします。
. SnapCenter とSnapCenter SQL Serverプラグインの間の通信を確認します。




== VM：SQL Server VMのリストア後の設定

VMのリストアが完了したら、SnapCenter でホストVMを再検出するための準備として、ネットワークやその他の項目を設定する必要があります。

. 管理およびiSCSIまたはNFS用に新しいIPアドレスを割り当てます。
. ホストをWindowsドメインに追加します。
. DNSにホスト名を追加するか、SnapCenter サーバのhostsファイルにホスト名を追加します。



NOTE: SnapCenter プラグインが現在のドメインとは異なるドメインクレデンシャルを使用して導入されている場合は、SQL Server VMでPlug-in for Windowsサービスのログオンアカウントを変更する必要があります。ログオンアカウントを変更したら、SnapCenter SMCore、Plug-in for Windows、およびPlug-in for SQL Serverの各サービスを再起動します。


NOTE: リストアされたVMをSnapCenter で自動的に再検出するには、FQDNをオンプレミスのSnapCenter に最初に追加されたVMと同じにする必要があります。



== SQL Serverリストア用にFSXストレージを構成します

SQL Server VMのディザスタリカバリリストアプロセスを実行するには、既存のSnapMirror関係をFSXクラスタから解除し、ボリュームへのアクセスを許可する必要があります。これには、次の手順を実行します。

. SQL Serverデータベースボリュームとログボリュームの既存のSnapMirror関係を解除するには、FSX CLIから次のコマンドを実行します。
+
....
FSx-Dest::> snapmirror break -destination-path DestSVM:DestVolName
....
. SQL Server Windows VMのiSCSI IQNを含むイニシエータグループを作成して、LUNへのアクセスを許可します。
+
....
FSx-Dest::> igroup create -vserver DestSVM -igroup igroupName -protocol iSCSI -ostype windows -initiator IQN
....
. 最後に、作成したigroupにLUNをマッピングします。
+
....
FSx-Dest::> lun mapping create -vserver DestSVM -path LUNPath igroup igroupName
....
. パス名を検索するには'lun showコマンドを実行します




== Windows VMでiSCSIアクセスを設定し、ファイルシステムを検出します

. SQL Server VMからiSCSIネットワークアダプタをセットアップし、FSXインスタンス上のiSCSIターゲットインターフェイスへの接続が確立されたVMwareポートグループ上で通信します。
. iSCSI Initiator Propertiesユーティリティを開き、Discovery、Favorite Targets、およびTargetsタブの古い接続設定を消去します。
. FSXインスタンス/クラスタ上のiSCSI論理インターフェイスにアクセスするためのIPアドレスを特定します。これは、AWSコンソールのAmazon FSX > ONTAP > Storage Virtual Machinesの下にあります。
+
image:dr-vmc-aws-image68.png["エラー：グラフィックイメージがありません"]

. [Discovery]タブで[Discover Portal]をクリックし、FSX iSCSIターゲットのIPアドレスを入力します。
+
image:dr-vmc-aws-image69.png["エラー：グラフィックイメージがありません"]

+
image:dr-vmc-aws-image70.png["エラー：グラフィックイメージがありません"]

. [ターゲット]タブで[接続]をクリックし、構成に応じて[マルチパスを有効にする]を選択し、[OK]をクリックしてターゲットに接続します。
+
image:dr-vmc-aws-image71.png["エラー：グラフィックイメージがありません"]

. コンピュータの管理ユーティリティを開き、ディスクをオンラインにします。以前と同じドライブレターを保持していることを確認します。
+
image:dr-vmc-aws-image72.png["エラー：グラフィックイメージがありません"]





== SQL Serverデータベースを接続します

. SQL Server VMで、Microsoft SQL Server Management Studioを開き、接続を選択してデータベースへの接続プロセスを開始します。
+
image:dr-vmc-aws-image73.png["エラー：グラフィックイメージがありません"]

. [追加]をクリックし、SQL Serverプライマリデータベースファイルが格納されているフォルダに移動して選択し、[OK]をクリックします。
+
image:dr-vmc-aws-image74.png["エラー：グラフィックイメージがありません"]

. トランザクションログが別のドライブにある場合は、トランザクションログが格納されているフォルダを選択します。
. 終了したら、[OK]をクリックしてデータベースに接続します。
+
image:dr-vmc-aws-image75.png["エラー：グラフィックイメージがありません"]





== SQL Server Plug-inとのSnapCenter 通信を確認します

SnapCenter データベースを以前の状態にリストアすると、SQL Serverホストが自動的に再検出されます。これを正しく機能させるには、次の前提条件に注意してください。

* SnapCenter はディザスタリカバリモードにする必要があります。これは、Swagger APIまたはディザスタリカバリのグローバル設定で実行できます。
* SQL ServerのFQDNは、オンプレミスのデータセンターで実行されていたインスタンスと同じである必要があります。
* 元のSnapMirror関係が解除されている必要があります。
* データベースを含むLUNをSQL Serverインスタンスにマウントし、データベースを接続しておく必要があります。


SnapCenter がディザスタリカバリモードになっていることを確認するには、SnapCenter Webクライアントで設定に移動します。[グローバル設定]タブに移動し、[災害復旧]をクリックします。ディザスタリカバリを有効にするチェックボックスがオンになっていることを確認します。

image:dr-vmc-aws-image76.png["エラー：グラフィックイメージがありません"]

link:aws-guest-dr-restore-oracle-data.html["次の手順：Oracleアプリケーションデータをリストアします。"]
