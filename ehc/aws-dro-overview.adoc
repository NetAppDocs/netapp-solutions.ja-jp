---
sidebar: sidebar 
permalink: ehc/aws-dro-overview.html 
keywords: NetApp Solutions, hybrid, multicloud, multi cloud, hyperscalers, vmware, disaster recovery orchestrator, DRO 
summary:  
---
= TR-4955：『Disaster Recovery with FSx ONTAP and VMC（AWS VMware Cloud）』
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
ディザスタリカバリオーケストレーションツール（DRO、UIを備えたスクリプト化されたソリューション）を使用すると、オンプレミスからFSx ONTAPにレプリケートされたワークロードをシームレスにリカバリできます。DROは、SnapMirrorレベルからVMCへのVM登録、NSX-T上のネットワークマッピングへのリカバリを自動化します。この機能は、すべてのVMC環境に含まれています。

ネットアップ、 Niyaz Mohamed



== 概要

クラウドへのディザスタリカバリは、耐障害性に優れた対費用効果の高い方法で、サイトの停止やデータ破損からワークロードを保護します（ランサムウェアなど）。NetApp SnapMirrorテクノロジを使用すると、オンプレミスのVMwareワークロードを、AWSで実行されるFSx ONTAPにレプリケートできます。

ディザスタリカバリオーケストレーションツール（DRO、UIを備えたスクリプト化されたソリューション）を使用すると、オンプレミスからFSx ONTAPにレプリケートされたワークロードをシームレスにリカバリできます。DROは、SnapMirrorレベルからVMCへのVM登録、NSX-T上のネットワークマッピングへのリカバリを自動化します。この機能は、すべてのVMC環境に含まれています。

image:dro-vmc-image1.png["この図は、オンプレミスのデータセンター、VMware Cloud on AWS SDDCインスタンス、およびAmazon FSx ONTAPの構造と相互接続を示しています。これには、SnapMirrorレプリケーション、DRaaS Opsトラフィック、インターネットまたは直接接続、VMware Transit Connectが含まれます。"]



== はじめに



=== AWSにVMware Cloudを導入して設定

link:https://www.vmware.com/products/vmc-on-aws.html["AWS 上の VMware Cloud"^]AWSエコシステムでVMwareベースのワークロードにクラウドネイティブなエクスペリエンスを提供します。各VMware Software-Defined Data Center（SDDC）はAmazon Virtual Private Cloud（VPC）内で動作し、フルVMwareスタック（vCenter Serverを含む）、NSXベースのSoftware-Defined Networking、VSANソフトウェア定義ストレージ、およびワークロードにコンピューティングリソースとストレージリソースを提供する1つ以上のESXiホストを提供します。AWSでVMC環境を設定するには、次の手順を実行しlink:aws-setup.html["リンク"^]ます。パイロットライトクラスタはDRにも使用できます。


NOTE: 初期リリースでは、DROは既存のパイロットライトクラスタをサポートします。オンデマンドのSDDC作成は、今後のリリースで提供される予定です。



=== FSx ONTAPのプロビジョニングと設定

Amazon FSx ONTAPは、広く普及しているNetApp ONTAPファイルシステムを基盤に構築された、信頼性、拡張性、パフォーマンス、機能豊富なファイルストレージを提供するフルマネージドサービスです。以下の手順に従って、link:aws-native-overview.html["リンク"^]FSx ONTAPのプロビジョニングと設定を行います。



=== FSx ONTAPへのSnapMirrorの導入と設定

次のステップでは、NetApp BlueXP  を使用して、プロビジョニングされたFSx ONTAP on AWSインスタンスを検出し、必要なデータストアボリュームをオンプレミス環境からFSx ONTAPにレプリケートします。その際、適切な頻度でNetApp Snapshotコピーを保持します。

image:dro-vmc-image2.png["この図は、有効なサービス間のさまざまなやり取りを示すBlueXP Canvas関係マップを示しています。"]

BlueXPを設定するには、このリンクの手順に従います。NetApp ONTAP CLIを使用して、このリンクに続くレプリケーションをスケジュールすることもできます。


NOTE: SnapMirror関係は前提条件であり、事前に作成しておく必要があります。



== DROのインストール

DROを開始するには、指定されたEC2インスタンスまたは仮想マシン上のUbuntuオペレーティングシステムを使用して、前提条件を満たしていることを確認します。次に、パッケージをインストールします。



=== 前提条件

* ソースおよびデスティネーションのvCenterおよびストレージシステムへの接続が存在することを確認してください。
* DNS名を使用する場合は、DNS解決を実施する必要があります。それ以外の場合は、vCenterとストレージシステムのIPアドレスを使用してください。
* root権限を持つユーザを作成します。EC2インスタンスではsudoも使用できます。




=== OSの要件

* Ubuntu 20.04（LTS）：2GB以上、vCPU×4
* 指定されたエージェントVMに次のパッケージがインストールされている必要があります。
+
** Docker
** docker -構成
** Jq




次の `sudo chmod 666 /var/run/docker.sock`権限を変更し `docker.sock`ます。


NOTE:  `deploy.sh`スクリプトは、必要なすべての前提条件を実行します。



=== パッケージをインストールします

. 指定した仮想マシンにインストールパッケージをダウンロードします。
+
[listing]
----
git clone https://github.com/NetApp/DRO-AWS.git
----
+

NOTE: このエージェントは、オンプレミスまたはAWS VPC内にインストールできます。

. パッケージを解凍して導入スクリプトを実行し、ホストIP（10.10.10.10など）を入力します。
+
[listing]
----
tar xvf DRO-prereq.tar
----
. ディレクトリに移動し、次のように配置スクリプトを実行します。
+
[listing]
----
sudo sh deploy.sh
----
. UIには次の方法でアクセスします。
+
[listing]
----
https://<host-ip-address>
----
+
次のデフォルトクレデンシャルを使用：

+
[listing]
----
Username: admin
Password: admin
----



NOTE: パスワードは、Change Passwordオプションを使用して変更できます。

image:dro-vmc-image3.png["Disaster Recovery Orchestratorのログイン画面。"]



== DRO構成

FSx ONTAPとVMCが適切に設定されたら、FSx ONTAPの読み取り専用SnapMirrorコピーを使用してオンプレミスのVMCへのワークロードのリカバリを自動化するDROの設定を開始できます。

NetAppでは、DROエージェントがオンプレミスのコンポーネントやFSx ONTAPおよびVMCリソースとネットワーク経由で通信できるように、AWSにDROエージェントを導入し、FSx ONTAPが導入されているVPCにもDROエージェントを導入することを推奨しています（ピア接続も可能です）。

まず、オンプレミスリソースとクラウドリソース（vCenterとストレージの両方）を検出してDROに追加します。サポートされているブラウザでDROを開き、デフォルトのユーザー名とパスワード（admin/admin）およびサイトの追加を使用します。サイトは、Discoverオプションを使用して追加することもできます。次のプラットフォームを追加します。

* オンプレミス
+
** オンプレミスのvCenter
** ONTAP ストレージシステム


* クラウド
+
** VMC vCenter
** FSX ONTAP の略




image:dro-vmc-image4.png["一時的なプレースホルダイメージ概要 。"]

image:dro-vmc-image5.png["ソースサイトとデスティネーションサイトを含むDROサイト概要ページ。"]

追加されると、DROは自動検出を実行し、ソースストレージからFSx ONTAPに対応するSnapMirrorレプリカを持つVMを表示します。DROは、VMが使用するネットワークとポートグループを自動的に検出して、それらにデータを入力します。

image:dro-vmc-image6.png["219台のVMと10個のデータストアを含む自動検出画面"]

次の手順では、必要なVMを、リソースグループとして機能するように機能グループにグループ化します。



=== リソースのグループ化

プラットフォームを追加したら、リカバリするVMをリソースグループにまとめることができます。DROリソースグループを使用すると、依存する一連のVMを論理グループにグループ化して、それらの起動順序、ブート遅延、およびリカバリ時に実行可能なオプションのアプリケーション検証を含めることができます。

リソースグループの作成を開始するには、次の手順を実行します。

. *リソースグループ*にアクセスし、*新しいリソースグループの作成*をクリックします。
. [新しいリソースグループ*]で、ドロップダウンからソースサイトを選択し、[*Create]をクリックします。
. リソースグループの詳細を入力し、*続行*をクリックします。
. 検索オプションを使用して、適切なVMを選択します。
. 選択したVMのブート順序とブート遅延（秒）を選択します。各VMを選択して優先順位を設定し、電源投入シーケンスの順序を設定します。3つはすべてのVMのデフォルト値です。
+
オプションは次のとおりです。

+
1–最初にパワーオンする仮想マシン3 -デフォルト5 -最後にパワーオンする仮想マシン

. [リソースグループの作成]をクリックします。


image:dro-vmc-image7.png["テストとDemoRG1の2つのエントリを含むリソースグループのリストのスクリーンショット。"]



=== レプリケーションプラン

災害発生時にアプリケーションをリカバリするための計画が必要です。ドロップダウンからvCenterのソースプラットフォームとデスティネーションプラットフォームを選択し、このプランに含めるリソースグループと、アプリケーションのリストア方法と電源オン方法のグループを選択します（ドメインコントローラ、ティア1、ティア2など）。このような計画は、ブループリントとも呼ばれます。リカバリ・プランを定義するには'[*レプリケーション・プラン*]タブに移動し'[*新しいレプリケーション・プラン*]をクリックします

レプリケーションプランの作成を開始するには、次の手順を実行します。

. *レプリケーションプラン*にアクセスし、*新しいレプリケーションプランの作成*をクリックします。
+
image:dro-vmc-image8.png["DemoRPという名前のプランを含むレプリケーションプラン画面のスクリーンショット"]

. [New Replication Plan]で、ソースサイト、関連するvCenter、デスティネーションサイト、および関連するvCenterを選択して、プランの名前を指定し、リカバリマッピングを追加します。
+
image:dro-vmc-image9.png["リカバリマッピングを含むレプリケーションプランの詳細のスクリーンショット。"]

. リカバリマッピングが完了したら、クラスタマッピングを選択します。
+
image:dro-vmc-image10.png["一時的なプレースホルダイメージ概要 。"]

. [*リソースグループの詳細*]を選択し、[*続行]をクリックします。
. リソースグループの実行順序を設定します。このオプションを使用すると、複数のリソースグループが存在する場合の処理の順序を選択できます。
. 完了したら、該当するセグメントへのネットワークマッピングを選択します。セグメントはVMC内でプロビジョニング済みである必要があるため、VMをマッピングする適切なセグメントを選択してください。
. VMを選択すると、データストアマッピングが自動的に選択されます。
+

NOTE: SnapMirrorはボリュームレベルです。したがって、すべてのVMがレプリケーションデスティネーションにレプリケートされます。必ずデータストアに含まれるすべてのVMを選択してください。選択しない場合は、レプリケーションプランの一部であるVMのみが処理されます。

+
image:dro-vmc-image11.png["一時的なプレースホルダイメージ概要 。"]

. VMの詳細の下では、オプションでVMのCPUパラメータとRAMパラメータのサイズを変更できます。これは、大規模な環境を小規模なターゲットクラスタにリカバリする場合や、1対1の物理VMwareインフラをプロビジョニングしなくてもDRテストを実行する場合に非常に役立ちます。また、リソースグループ内の選択したすべてのVMのブート順序とブート遅延（秒）を変更することもできます。リソースグループのブート順序の選択時に選択したブート順序に変更が必要な場合は、追加のオプションを使用してブート順序を変更できます。デフォルトでは、リソースグループの選択時に選択したブート順序が使用されますが、この段階で変更を行うことができます。
+
image:dro-vmc-image12.png["一時的なプレースホルダイメージ概要 。"]

. レプリケーションプランの作成*をクリックします。
+
image:dro-vmc-image13.png["一時的なプレースホルダイメージ概要 。"]



レプリケーションプランの作成後は、要件に応じて、フェイルオーバーオプション、テストフェイルオーバーオプション、または移行オプションを実行できます。フェイルオーバーおよびテストフェイルオーバーのオプションでは、最新のSnapMirror Snapshotコピーが使用されるほか、（SnapMirrorの保持ポリシーに基づいて）ポイントインタイムのSnapshotコピーから特定のSnapshotコピーを選択できます。ポイントインタイムオプションは、ランサムウェアなどの破損イベントに直面している場合に、最新のレプリカがすでに侵害されているか暗号化されていると非常に役立ちます。DROは、使用可能なすべてのポイントを時間単位で表示します。レプリケーションプランで指定された構成でフェイルオーバーまたはテストフェイルオーバーをトリガーするには、*フェイルオーバー*または*テストフェイルオーバー*をクリックします。

image:dro-vmc-image14.png["一時的なプレースホルダイメージ概要 。"] image:dro-vmc-image15.png["この画面では、ボリュームSnapshotの詳細が表示され、最新のSnapshotを使用するか特定のSnapshotを選択するかを選択できます。"]

レプリケーションプランは、次のタスクメニューで監視できます。

image:dro-vmc-image16.png["タスクメニューには、レプリケーションプランのすべてのジョブとオプションが表示され、ログを確認することもできます。"]

フェイルオーバーがトリガーされると、リカバリされた項目をVMC vCenter（VM、ネットワーク、データストア）で確認できます。デフォルトでは、VMはWorkloadフォルダにリカバリされます。

image:dro-vmc-image17.png["一時的なプレースホルダイメージ概要 。"]

フェイルバックは、レプリケーションプランレベルで実行できます。テストフェイルオーバーでは、ティアダウンオプションを使用して変更をロールバックし、FlexClone関係を削除できます。フェイルオーバーに関連したフェイルバックは、2つのステップで行います。レプリケーションプランを選択し、*リバースデータ同期*を選択します。

image:dro-vmc-image18.png["リバースデータ同期オプションを含むドロップダウンを含むレプリケーションプランの概要のスクリーンショット。"] image:dro-vmc-image19.png["一時的なプレースホルダイメージ概要 。"]

完了したら、フェイルバックを開始して元の本番サイトに戻すことができます。

image:dro-vmc-image20.png["[フェイルバック]オプションを含むドロップダウンを含むレプリケーションプランの概要のスクリーンショット"] image:dro-vmc-image21.png["元のプロダクションサイトがアップして実行されているDROサマリーページのスクリーンショット。"]

NetApp BlueXPでは、該当するボリューム（読み書き可能ボリュームとしてVMCにマッピングされているボリューム）のレプリケーションの健常性が遮断されていることがわかります。テストフェイルオーバー中、DROはデスティネーションボリュームまたはレプリカボリュームをマッピングしません。代わりに、必要なSnapMirror（またはSnapshot）インスタンスのFlexCloneコピーが作成され、FlexCloneインスタンスが公開されます。これにより、FSx ONTAPの物理容量が追加で消費されることはありません。このプロセスにより、DRのテストや優先度の異なるワークフローの実行中も、ボリュームが変更されず、レプリカジョブを続行できます。また'このプロセスにより'エラーが発生した場合や破損したデータがリカバリされた場合には'レプリカが破壊されるリスクを伴わずにリカバリをクリーンアップできます

image:dro-vmc-image22.png["一時的なプレースホルダイメージ概要 。"]



=== ランサムウェアからのリカバリ

ランサムウェアからのリカバリは困難な作業です。具体的には、IT組織にとっては、安全な返品ポイントが特定され、復元されたワークロードを、睡眠中のマルウェアや脆弱なアプリケーションなどから再発生する攻撃から保護するために、ピンポイントを確立することは困難です。

DROは、利用可能な任意の時点からシステムを回復できるようにすることで、このような問題に対処します。また、機能的で分離されたネットワークにワークロードをリカバリして、南北トラフィックにさらされない場所でアプリケーションが機能し、相互に通信できるようにすることもできます。これにより、セキュリティチームはフォレンジックを実行する安全な場所を手に入れ、隠れているマルウェアや睡眠中のマルウェアが存在しないことを確認できます。



== メリット

* 効率性と耐障害性に優れたSnapMirrorレプリケーションの使用：
* Snapshotコピーの保持により、任意の時点までのリカバリが可能
* ストレージ、コンピューティング、ネットワーク、アプリケーションの検証から、数百から数千のVMをリカバリするのに必要なすべての手順を完全に自動化します。
* ONTAP FlexCloneテクノロジを使用したワークロードのリカバリ：レプリケートされたボリュームを変更しない方法を使用します。
+
** ボリュームやSnapshotコピーのデータが破損するリスクを回避します。
** DRテストのワークフロー中にレプリケーションが中断されるのを回避します
** DRデータとクラウドコンピューティングリソースを組み合わせたDRデータの使用は、DR以外のワークフロー（DevTest、セキュリティテスト、パッチテスト、アップグレードテスト、修復テストなど）にも適しています。


* CPUとRAMの最適化により、小規模なコンピューティングクラスタへのリカバリが可能になり、クラウドコストを削減

