---
sidebar: sidebar 
permalink: vm-migrate/shift-toolkit-migration.html 
keywords: netapp, vmware, esxi, vm, migration, openshift, virtualization, hyper-v, proxmox 
summary:  
---
= Shiftツールキットを使用したVMの移行
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
このセクションでは、Shift Toolkitを使用してVMを移行する方法について説明します。



== 移行

ブループリントが作成されたら、[Migrate]オプションを実行できます。移行オプションの実行中、Shift Toolkitは一連の手順を実行してディスクフォーマットを変換し、変換したディスクを使用してHyper-Vホスト上に仮想マシンを作成します。この手順はブループリントで定義されています。

実行する手順の概要は次のとおりです。

前提条件：移行を開始する前に、移行がアドホックであるか、計画されたメンテナンス時間に基づいてスケジュールされているかに関係なく、仮想マシン（VM）の電源が正常にオフになっていることを確認してください。VMが完全にシャットダウンされていることを確認します。オペレーティングシステムが更新を保留している場合は、VMが完全にシャットダウンしてから移行を開始します。

* ブループリント内のすべてのVMの既存のスナップショットを削除する
* ブループリントのVMスナップショットをソースでトリガー
* ディスク変換前にボリュームスナップショットをトリガー
* すべてのVMのVMDKをクローニングしてVHDx形式に変換
* 保護グループ内のVMの電源をオンにする（ターゲットで）
* 各VM上のネットワークの登録
* VMwareツールを削除し、OSタイプに応じてトリガースクリプトまたはcronジョブを使用してIPアドレスを割り当てる




=== 考慮すべき要因

移行を開始する前に、前提条件がすべて満たされていることを確認します（前提条件については、このドキュメントの「前提条件」セクションで詳しく説明します）。まとめのための簡単なチェックリストを以下に示します。

* Shift VMがドメインの一部であることを確認する
* CIFS共有に適切な権限が設定されていることを確認する
* マイグレーションまたは変換に使用されるqtreeのセキュリティ形式が適切である
* 簡単なテストとして、クラスタ内の任意のHyper-VホストからHyper-Vマネージャを使用してVMを作成し、VHDXをCIFS共有に配置します（箇条書き–A参照）。ShiftツールキットVMからHyper-V管理ツールを追加して同様の操作を実行します（[Programs and Features]または[PowerShell]-add-WindowsFeature RSAT-Hyper-V-toolsを使用）。



NOTE: エラーがある場合は、link:https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/manage/remotely-manage-hyper-v-hosts["任意の認証プロトコルを使用して委譲を有効にする"]。



=== ネットワークのヒントと考慮事項

ネットワークに関する次の考慮事項を考慮する必要があります。

* 静的IPアドレスが使用可能であり、別のVMに割り当てられていないことを確認する


Windows VMの場合：

* prepareスクリプトは、ネットワーク設定の詳細（IPアドレス空間、ゲートウェイアドレス、DNSサーバ）のコピーを作成し、トリガースクリプト（移行中）は、ブループリントマッピングに基づいて単一のNICまたは複数のNICでネットワーク設定を再適用します。
* 移行後も、Windowsデバイスマネージャには移行前の古いネットワークアダプタ情報が表示されることがあります。これは移行後に作成された新しいネットワークアダプタには影響せず、IPの競合は発生しませんが、スクリプトは現在この古い登録を削除しないため、表示されたままになります。


Linux VMの場合：

* prepareスクリプトは、ネットワーク設定の詳細（IPアドレススペース、ルート、DNSサーバ、ネットワークデバイス名）のコピーを作成します。Linuxディストリビューションによっては、使用するネットワークタイプを特定し、IP設定を適用します。ネットワーク再割り当てスクリプトは、crontabを使用してcronジョブとして設定され、ブート時にトリガーされます。たとえば、cronjobはインスタンス上で（移行後に）スクリプトを実行し、ブループリントマッピングに基づいて単一のNICまたは複数のNICにネットワーク設定を再適用します。
* 特定のシナリオでは、変換されたHyper-V VMのインターフェイス名は、ソース側のens192や33ではなく、eth0やeth1のようになります。この場合、スクリプトは新しいインターフェイス名に一致するようにネットワーク設定の詳細を更新します。（最新のシステムのように）予測可能な名前が使用されていて、インターフェイス名がHyper-V側で保持されている場合、スクリプトはネットワーク側をスキップし、VMwareツールを削除してからVMをリブートします。
* Shift Toolkitは現在、NetworkManager、Netplan、およびifconfigメカニズムをサポートしており、ブループリントで指定されたIPを保持しています。




=== フェーズとオプション

移行プロセスの主なフェーズとオプションを次に示します。

. VMの準備–移行に備えてVMを準備し、すべての前提条件が完全に満たされていることを確認します。
. 移行-準備が完了したら、VMware VMを選択してHyper-Vに移行します。移行が完了したら、VMが正常にブートし、データが適切に移行されたことを確認します。
. Test Migrate -テスト移行では、VMDKをVHDXに変換し、SMB共有上にある変換済みVHDXファイルを使用してHyper-V VMを作成することで、移行をシミュレートします。テスト移行では、ネットワークマッピングの設定は許可されません。このタスクは通常、バブルネットワークに対して手動で実行する必要があります。
. 移行の再試行–移行が失敗した場合、Shiftツールキットには再試行オプションが用意されています。この機能を使用すると、障害点から移行ジョブを再開できます。処理を再試行する前に、エラーメッセージを確認して修正することが重要です。



NOTE: Shiftツールキットでは、VMの準備に必要なスクリプトをコピーする以外、ソースVMは変更されません。これにより、変換が失敗した場合に迅速にロールバックできます。

ブループリントで指定した構成で移行ワークフローをトリガーするには、[移行]をクリックします。

image:shift-toolkit-image50.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

ワークフローが開始されると、ワークフローがアクティブになり、変換プロセスは概説された手順に従ってVMを登録します。ブループリント内のVMの電源がオフになっていない場合、Shiftツールキットは、処理を続行する前に正常なシャットダウンを求めるプロンプトを表示します。

image:shift-toolkit-image51.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: 同じESXiソースから同じHyper-Vデスティネーションに対して並行して実行される変換は10個以下にすることを推奨します。

image:shift-toolkit-image52.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

VMDKからVHDxへの変換は数秒で行われるため、追加コストがかかるすべてのオプションの中で、このアプローチが最も高速です。これは、移行中のVMのダウンタイムを削減するのにも役立ちます。

image:shift-toolkit-image53.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

ジョブが完了すると、ブループリントのステータスが「移行完了」に変わります。

image:shift-toolkit-image54.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

移行が完了したら、Hyper-V側のVMを検証します。以下のスクリーンショットは、ブループリントの作成時に指定したHyper-Vホスト上で実行されているVMを示しています。

image:shift-toolkit-image55.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: Shift Toolkitは、ブート時に実行されるcronジョブを使用します。Hyper-VホストでVMを購入すると、LinuxベースのVMに対してssh接続や同等の機能が作成されることはありません。

image:shift-toolkit-image56.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: Windows VMの場合、Shift Toolkitは、これらのWindowsベースのゲストVMにPowerShell直接接続します。PowerShell Directでは、ネットワーク構成やリモート管理設定に関係なく、WindowsベースのゲストVMに接続できます。


NOTE: 変換後、OSディスクを除くWindows OS上のすべてのVMディスクがオフラインになります。これは、VMware VMではNewDiskPolicyパラメータがデフォルトでofflineALLに設定されているためです。この問題の原因は、デフォルトのMicrosoft Windows SANポリシーです。このポリシーは、複数のサーバからアクセスされているWindows Serverの起動時にLUNがアクティブ化されないように設計されています。これは、データ破損の可能性がある問題を回避するために行われます。これには、PowerShellコマンドを実行します。Set-StorageSetting -NewDiskPolicy OnlineAll


NOTE: VMのステージングには複数のボリュームを使用するため、必要に応じてVMを別のボリュームに移動する必要があります。リソースグループに大規模なVMDKを含むVMが含まれている場合は、変換用にそれらを複数のボリュームに分散します。このアプローチでは、クローンスプリットをバックグラウンドで実行しながら、別 々 のボリュームでクローニング処理を並行して実行することで、snapshot busyエラーを防ぐことができます。
