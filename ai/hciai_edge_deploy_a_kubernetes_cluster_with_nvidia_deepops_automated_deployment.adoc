---
sidebar: sidebar 
permalink: ai/hciai_edge_deploy_a_kubernetes_cluster_with_nvidia_deepops_automated_deployment.html 
keywords:  
summary:  
---
= NVIDIA DeepOps 自動導入で Kubernetes クラスタを導入
:hardbreaks:
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/


[role="lead"]
NVIDIA DeepOps で Kubernetes クラスタを導入して設定するには、次の手順を実行します。

. Kubernetes のすべてのマスターノードとワーカーノードに同じユーザアカウントが存在することを確認します。
. DeepOps リポジトリのクローンを作成します。
+
....
git clone https://github.com/NVIDIA/deepops.git
....
. 最新のリリースタグをチェックしてください。
+
....
cd deepops
git checkout tags/20.08
....
+
この手順をスキップすると、公式リリースではなく、最新の開発コードが使用されます。

. 必要な前提条件をインストールして、 Deployment Jump を準備します。
+
....
./scripts/setup.sh
....
. VI エディタを開いて Ansible インベントリを作成および編集し、「 eppops/config/inventory 」を開きます。
+
.. [ すべて ] の下にすべてのマスターノードとワーカーノードを一覧表示します。
.. [kube-master] の下にあるすべてのマスターノードを一覧表示します。
.. [etcd] の下にあるすべてのマスターノードを一覧表示します。
.. [kube-node] の下にあるすべてのワーカーノードを一覧表示します。
+
image:hciaiedge_image9.png["エラー：グラフィックイメージがありません"]



. VI エディタを開いて '`epps/config/group_vars/k8s-cluster.yml` に GPUOperator を有効にします
+
image:hciaiedge_image10.png["エラー：グラフィックイメージがありません"]

. 「 deepops_gpu_operator_enabled 」の値を true に設定します。
. 権限とネットワーク設定を確認します。
+
....
ansible all -m raw -a "hostname" -k -K
....
+
** リモートホストへの SSH でパスワードが必要な場合は、 -K を使用します
** リモートホストの sudo でパスワードが必要な場合は、 -K を使用します


. 問題なく前の手順に合格した場合は、 Kubernetes のセットアップを続行します。
+
....
ansible-playbook --limit k8s-cluster playbooks/k8s-cluster.yml -k -K
....
. Kubernetes ノードとポッドのステータスを確認するには、次のコマンドを実行します。
+
....
kubectl get nodes
....
+
image:hciaiedge_image11.png["エラー：グラフィックイメージがありません"]

+
....
kubectl get pods -A
....
+
すべてのポッドが実行されるまでに数分かかる場合があります。

+
image:hciaiedge_image12.png["エラー：グラフィックイメージがありません"]

. Kubernetes セットアップが GPU にアクセスして使用できることを確認します。
+
....
./scripts/k8s_verify_gpu.sh
....
+
想定される出力例：

+
....
rarvind@deployment-jump:~/deepops$ ./scripts/k8s_verify_gpu.sh
job_name=cluster-gpu-tests
Node found with 3 GPUs
Node found with 3 GPUs
total_gpus=6
Creating/Deleting sandbox Namespace
updating test yml
downloading containers ...
job.batch/cluster-gpu-tests condition met
executing ...
Mon Aug 17 16:02:45 2020
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 440.64.00    Driver Version: 440.64.00    CUDA Version: 10.2     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   0  Tesla T4            On   | 00000000:18:00.0 Off |                    0 |
| N/A   38C    P8    10W /  70W |      0MiB / 15109MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
Mon Aug 17 16:02:45 2020
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 440.64.00    Driver Version: 440.64.00    CUDA Version: 10.2     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   0  Tesla T4            On   | 00000000:18:00.0 Off |                    0 |
| N/A   38C    P8    10W /  70W |      0MiB / 15109MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
Mon Aug 17 16:02:45 2020
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 440.64.00    Driver Version: 440.64.00    CUDA Version: 10.2     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   0  Tesla T4            On   | 00000000:18:00.0 Off |                    0 |
| N/A   38C    P8    10W /  70W |      0MiB / 15109MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
Mon Aug 17 16:02:45 2020
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 440.64.00    Driver Version: 440.64.00    CUDA Version: 10.2     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   0  Tesla T4            On   | 00000000:18:00.0 Off |                    0 |
| N/A   38C    P8    10W /  70W |      0MiB / 15109MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
Mon Aug 17 16:02:45 2020
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 440.64.00    Driver Version: 440.64.00    CUDA Version: 10.2     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   0  Tesla T4            On   | 00000000:18:00.0 Off |                    0 |
| N/A   38C    P8    10W /  70W |      0MiB / 15109MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
Mon Aug 17 16:02:45 2020
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 440.64.00    Driver Version: 440.64.00    CUDA Version: 10.2     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   0  Tesla T4            On   | 00000000:18:00.0 Off |                    0 |
| N/A   38C    P8    10W /  70W |      0MiB / 15109MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
Number of Nodes: 2
Number of GPUs: 6
6 / 6 GPU Jobs COMPLETED
job.batch "cluster-gpu-tests" deleted
namespace "cluster-gpu-verify" deleted
....
. デプロイメントジャンプに Helm をインストールします。
+
....
./scripts/install_helm.sh
....
. マスターノードの汚染を除去します。
+
....
kubectl taint nodes --all node-role.kubernetes.io/master-
....
+
この手順は、ロードバランサポッドを実行するために必要です。

. LoadBalancer を展開します。
. 'config/helm/metallb.yml` ファイルを編集し、ロードバランサとして使用される「アプリケーションネットワーク」の IP アドレスの範囲を提供します。
+
....
---
# Default address range matches private network for the virtual cluster
# defined in virtual/.
# You should set this address range based on your site's infrastructure.
configInline:
  address-pools:
  - name: default
    protocol: layer2
    addresses:
    - 172.21.231.130-172.21.231.140#Application Network
controller:
  nodeSelector:
    node-role.kubernetes.io/master: ""
....
. ロードバランサを導入するスクリプトを実行します。
+
....
./scripts/k8s_deploy_loadbalancer.sh
....
. 入力コントローラを配置します。
+
....
./scripts/k8s_deploy_ingress.sh
....


link:hciai_edge_deploy_and_configure_ontap_select_in_the_vmware_virtual_infrastructure_automated_deployment.html["次のステップ： VMware 仮想インフラストラクチャへの ONTAP Select の導入と構成（自動導入）"]
