---
sidebar: sidebar 
permalink: kvm/kvm-overview.html 
keywords: libvirt, kvm, qemu, lxc, vm 
summary:  
---
= KVM仮想化の概要
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
KVM、QEMU、Libvirt は Linux 仮想化スタックの主要コンポーネントであり、それぞれが仮想マシンの有効化と管理において異なる役割を果たします。



== コンポーネントの概要

. KVM (カーネルベースの仮想マシン):
+
** 役割: KVM は、CPU のハードウェア支援仮想化拡張機能 (Intel VT-x や AMD-V など) を活用してコア仮想化機能を提供するカーネル モジュールです。
** 機能: KVM を使用すると、Linux カーネルがタイプ 1 ハイパーバイザーとして機能し、CPU およびメモリ操作のネイティブに近いパフォーマンスで仮想マシンを作成および管理できるようになります。
** 最下位層: KVM は最下位レベルのコンポーネントであり、ハードウェアと直接対話して、完全な仮想化に必要なインフラストラクチャを提供します。


. QEMU (クイックエミュレータ):
+
** 役割: QEMU は、ネットワーク インターフェイス、ディスク コントローラー、グラフィック カードなど、ゲスト システムのその他の仮想化ハードウェア コンポーネントを提供するマシン (ハードウェア) エミュレーターです。
** 機能：KVMが利用できない場合、QEMUはタイプ2ハイパーバイザーとして動作できますが、ゲストCPUをソフトウェアでシミュレートする必要があるため、動作速度が大幅に低下します。KVMと組み合わせると、QEMUはKVMを使用してCPUとメモリの操作を高速化し、周辺機器やその他のハードウェアデバイスのエミュレーションをQEMUが処理します。
** KVM との対話: QEMU は、ioctl() システム コールを使用してデバイス ファイル (例: /dev/kvm) を介して KVM と対話し、仮想マシン プロセスを管理して KVM と通信します。


. https://wiki.libvirt.org/FAQ.html["リブバート"]：
+
** 役割: Libvirt は、KVM/QEMU、Xen、VMware ESXi などのさまざまな仮想化プラットフォームに高レベルの管理インターフェイスを提供する仮想化ライブラリおよび API です。
** 機能：Libvirtは、統一されたインターフェースとツールセットを提供することで、仮想マシンの管理を簡素化します。抽象化レイヤーとして機能し、ユーザーとアプリケーションは、基盤となるハイパーバイザー固有のコマンドやAPIを直接操作することなく、仮想マシンを管理できます。
** 主な特長：
+
*** VM ライフサイクル管理: VM の起動、停止、一時停止、保存、復元、移行。
*** リモート管理: SSH またはその他のプロトコルを介してリモート ホスト上の VM を制御します。
*** ストレージ管理: VM のストレージ プールとボリュームを作成および管理します。
*** 仮想ネットワーク: NAT、ブリッジ、その他のモードを使用して仮想ネットワークを構成します。
*** セキュリティ: VM のセキュリティ制限のために SELinux および AppArmor と統合します。
*** ホットプラグ: VM の実行中にディスクやネットワーク インターフェイスなどのデバイスを追加または削除します。
*** ツール: Libvirt には、VM を管理するための virsh などのコマンドライン ツールと virt-manager などのグラフィカル ツールが含まれています。


** どのように連携するか:
+
*** KVM: カーネルレベルの仮想化インフラストラクチャを提供します。
*** QEMU: エミュレートされたハードウェアを提供し、VM プロセスを管理します。
*** Libvirt: 管理レイヤーとして機能し、KVM/QEMU やその他のハイパーバイザーを制御するための API とツールを提供します。


** 本質的には、KVM は仮想化のためのハードウェア アクセラレーションを提供し、QEMU はエミュレートされたハードウェアを提供し VM を実行し、Libvirt はセットアップ全体を制御するためのユーザーフレンドリーな管理インターフェイスと API を提供します。




libvirtクライアントツールは、コックピットマシンを使用して、CLI、GUI、またはWebベースからVMや操作を管理するために使用できます。libvirtを使用するアプリケーションのリストについては、以下を参照してください。  https://libvirt.org/apps.html["ここをクリック"] 。

アプリケーションが Kubernetes 環境に移行するときは、Kubevirt を検討して、それらの環境で仮想マシンをポッドとして実行してください。

https://galaxy.ansible.com/ui/repo/published/community/libvirt/["Ansibleモジュールはlibvirtで利用可能"]自動化のためです。



== クラスタ管理

通常、Virtualization Manager または virsh cli ツールは、一度に 1 台のホストを管理します。クラスター内の複数のホストを管理するには、oVirt、CloudStack、OpenStack などの高レベルアプリケーションがよく使用されます。これらのツールは、VM の配置と負荷分散に役立ちます。小規模なクラスター環境で特定の VM の高可用性が必要な場合は、Pacemaker と Corosync を使用するか、管理スタックのオプションを確認してください。

image:kvm-overview-image01.png["管理コンポーネントを備えた Libvirt スタック"]



== コンピューティング

Libvirtは、仮想マシンのリソースと機能を管理するための包括的なフレームワークを提供します。これには、以下のタスクが含まれます。

. 仮想マシン（ドメイン）管理:
+
** ライフサイクル操作：Libvirtは、仮想マシン（libvirt用語では「ドメイン」と呼ばれます）の状態を管理するための包括的な操作セットを提供します。これには、VMの起動、停止、一時停止、再開、保存、復元、移行が含まれます。
** XML 構成: 仮想マシンの構成は XML ファイルを使用して定義されます。virshや virt-manager などのツールを使用して、これらの XML 構成を作成、変更、削除できます。
** リモート管理: SSH などのさまざまなネットワーク トランスポートをサポートする libvirt のリモート プロトコルを使用して、リモート ホスト上の仮想マシンを管理できます。


. リソースの割り当てと管理:
+
** CPU 管理: Libvirt を使用すると、仮想 CPU の数の指定、CPU ピンニングの制御 (vCPU をホスト上の特定の物理 CPU に関連付ける)、CPU モードの管理 (ホストの CPU 機能をゲストに公開するホスト パススルーなど) など、ゲスト CPU を構成できます。
** メモリ管理: 仮想マシンにメモリを割り当て、メモリのオーバーコミット (VM に割り当てられたメモリの合計がホストで使用可能な物理メモリを超えることを許可する) を構成できます。
** ストレージ管理: Libvirt は、ディスク イメージ (qcow2、vmdk、raw などの形式)、NFS 共有、LVM ボリューム グループ、iSCSI 共有、raw ディスク デバイスなど、仮想マシンのさまざまなタイプのストレージを管理できます。
** ホスト デバイス管理: SR-IOV や NPIV などの仮想化機能を含む、USB、PCI、SCSI、ネットワーク デバイスなどの物理および仮想ホスト デバイスを管理できます。


. 仮想ネットワーク:
+
** 仮想ネットワーク スイッチ: Libvirt は、仮想マシンを相互に、またホスト ネットワークに接続するための仮想ネットワーク スイッチ (ブリッジ) を作成します。
** ネットワーク モード: NAT、ブリッジ、分離、ルーティングなどのさまざまなネットワーク モードをサポートし、VM がネットワークと対話する方法を構成します。
** ファイアウォール ルール: Libvirt は、ファイアウォール ルール (iptables を使用) を自動的に管理し、仮想ネットワークのネットワーク トラフィックを制御します。


. パフォーマンスの最適化:
+
** CPU 固定: vCPU を特定の物理 CPU に固定すると、特に NUMA 環境でキャッシュ効率とパフォーマンスが向上します。
** NUMA チューニング: ゲスト サイズを単一の NUMA ノード上のリソースの量に制限し、vCPU とメモリを I/O アダプタに接続されている同じ物理ソケットに固定することで、NUMA システムのパフォーマンスを最適化できます。
** Hugepages: Hugepages を使用すると、小さなメモリ ページの管理に関連するオーバーヘッドが削減され、パフォーマンスが向上します。


. 他のツールとの統合:
+
** virsh: libvirt と対話するためのコマンドライン インターフェイス。
** virt-manager: 仮想マシンと libvirt リソースを管理するためのグラフィカル ツール。
** OpenStack: Libvirt は、OpenStack でよく使用される仮想化ドライバーです。
** サードパーティ ツール: クラウド管理プラットフォームやバックアップ ソリューションなど、他の多くのツールやアプリケーションでは、仮想マシンの管理に libvirt の API を活用しています。




KVMハイパーバイザーは、VMゲストが十分に活用されていない状況でCPUとメモリをオーバーコミットすることを許可します。ただし、パフォーマンスを向上させるには、監視とバランス調整が必要です。

VMのメタデータはXML形式で/etc/libvirt/qemuに保存されます。VMはvirt-installまたはvirsh cliを使用して作成できます。UIを優先する場合はVirt-Managerを、上位の管理スタックを使用する場合はVirt-Managerを利用できます。

要約すると、libvirt は仮想化のコンピューティング面に対する包括的な管理レイヤーを提供し、仮想マシンのライフサイクルの制御、リソースの割り当て、ネットワークの構成、パフォーマンスの最適化、および他のツールやプラットフォームとの統合を可能にします。



== ストレージ

VMディスクは、ストレージプールに動的にプロビジョニングすることも、ストレージ管理者がVM用に事前にプロビジョニングすることもできます。libvirtは様々なプールタイプをサポートしています。以下は、適用可能なプールタイプとサポートされているストレージプロトコルの一覧です。一般的な選択肢はdirです。次にnetfsとlogicalです。iscsiとiscsi-directは単一のターゲットを使用し、フォールトトレランスは提供しません。mpathはマルチパスを提供しますが、動的割り当ては行いません。vSphereにおけるrawデバイスマッピングのように使用されます。 https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/10/html/managing_file_systems/mounting-file-systems-on-demand#the-autofs-service["自動マウント"]またはfstabとdirプールタイプが使用されます。ブロックプロトコル（iSCSI、FC、NVMe-oF）の場合は、ocfs2やgfs2などの共有ファイルシステムが使用されます。

[cols="20% 10% 10% 10% 10% 10% 10% 10%"]
|===
| ストレージ プロトコル | ディレクター | フェス | ネットファイル | 論理的 | ディスク | iSCSI | iSCSIダイレクト | mpath 


| SMB / CIFS | はい | いいえ | はい | いいえ | いいえ | いいえ | いいえ | いいえ 


| NFS | はい | いいえ | はい | いいえ | いいえ | いいえ | いいえ | いいえ 


| iSCSI | はい | はい | いいえ | はい | はい | はい | はい | はい 


| FC | はい | はい | いいえ | はい | はい | いいえ | いいえ | はい 


| NVMe-oF | はい | はい | いいえ | はい | はい | いいえ | いいえ | いいえ^1^ 
|===
*注:* 1 - 追加の構成が必要になる場合があります。

使用するストレージプロトコルに応じて、ホスト上で追加のパッケージが利用可能である必要があります。サンプルリストを以下に示します。

[cols="40% 20% 20% 20%"]
|===
| ストレージ プロトコル | フェドーラ | Debian | パックマン 


| SMB / CIFS | sambaクライアント/cifs-utils | smbclient/cifs-utils | smbclient/cifs-utils 


| NFS | nfs-utils | nfs-共通 | nfs-utils 


| iSCSI | iscsi-initiator-utils、device-mapper-multipath、ocfs2-tools/gfs2-utils | open-iscsi、マルチパスツール、ocfs2-tools/gfs2-utils | open-iscsi、マルチパスツール、ocfs2-tools/gfs2-utils 


| FC | sysfsutils、デバイスマッパーマルチパス、ocfs2-tools/gfs2-utils | sysfsutils、マルチパスツール、ocfs2ツール/gfs2ユーティリティ | sysfsutils、マルチパスツール、ocfs2ツール/gfs2ユーティリティ 


| NVMe-oF | nvme-cli、ocfs2-tools/gfs2-utils | nvme-cli、ocfs2-tools/gfs2-utils | nvme-cli、ocfs2-tools/gfs2-utils 
|===
ストレージ プールの詳細は、/etc/libvirt/storage の XML ファイルに保存されます。

vSphere環境からVMデータをインポートするには、  https://docs.netapp.com/us-en/netapp-solutions/vm-migrate/shift-toolkit-overview.html["シフトツールキット"] 。



== ネットワーク

Libvirtは、仮想マシンとコンテナを管理するための堅牢な仮想ネットワーク機能を提供します。これは、仮想ネットワークスイッチまたはブリッジの概念を通じて実現されます。

コアコンセプト： * 仮想ネットワークスイッチ（ブリッジ）：これはホストサーバー上のソフトウェアベースのネットワークスイッチのように機能します。仮想マシンはこのスイッチに接続し、トラフィックはこのスイッチを経由して流れます。* TAPデバイス：これらは、仮想マシンのネットワークインターフェースをlibvirtブリッジに接続する「仮想ケーブル」として機能する特殊なネットワークデバイスです。

* ネットワーク モード: Libvirt はさまざまなニーズを満たすためにさまざまなネットワーク構成をサポートしています。
+
** NAT（ネットワーク アドレス変換）：これがデフォルトのモードです。NATネットワークに接続された仮想マシンは、ホストの IP アドレスを使用して外部ネットワークにアクセスできますが、外部ホストは仮想マシンへの接続を直接開始することはできません。
** ブリッジ：このモードでは、仮想ネットワークはホストと同じネットワークセグメントに直接接続されます。これにより、VMは物理ネットワークに直接接続されているかのように見えます。
** 分離：分離されたネットワーク上のVMは、互いに通信したりホストと通信したりできますが、ホストの外部にアクセスすることはできません。これは、テスト環境やセキュアな環境に役立ちます。
** ルーティング：仮想ネットワークからのトラフィックは、NATを介さずに物理ネットワークにルーティングされます。これには、ホストネットワーク上で適切なルーティング設定が必要です。
** オープン: ルーティングモードに似ていますが、libvirtによって自動的に適用されるファイアウォールルールはありません。ネットワークトラフィックは他のシステムによって管理されることを前提としています。


* DHCP と DNS: Libvirt は dnsmasq を使用して仮想ネットワークの DHCP サービスを管理できるため、VM に IP アドレスを割り当て、仮想ネットワーク内で DNS 解決を処理できます。
* ファイアウォール ルール: Libvirt は、特に NAT モードで、仮想ネットワークのトラフィック フローを制御するために iptables ルールを自動的に設定します。


Libvirt ネットワークの管理:

* virsh: virsh コマンドライン ツールは、ネットワークの一覧表示、開始、停止、定義、定義解除など、仮想ネットワークを管理するための包括的なコマンド セットを提供します。
* 仮想マシン マネージャー (virt-manager): このグラフィカル ツールは、直感的なユーザー インターフェイスを使用して仮想ネットワークの作成と管理を簡素化します。
* XML設定：LibvirtはXMLファイルを使用して仮想ネットワークの設定を定義します。これらのXMLファイルを直接編集することも、virsh net-editなどのツールを使用してネットワーク設定を変更することもできます。


一般的な使用例:

* NAT: 単一のネットワーク インターフェイスを持つホスト上の VM に対するシンプルで基本的な接続。
* ブリッジ: VM を既存のネットワークにシームレスに統合します。
* 分離: VM が外部からのアクセスを制限された安全な環境またはテスト環境を作成します。
* ルーティング: 特定のルーティングが必要なより高度なシナリオ。
* Open vSwitch (OVS): 高度なネットワーク管理と自動化を必要とする複雑で大規模な展開向け。


これらの機能を活用することで、libvirt は Linux 環境で仮想マシン ネットワークを管理するための柔軟で強力なフレームワークを提供します。



== 監視

NetApp Data Infrastructure Insights (旧称 Cloud Insights) は、仮想マシンを含む IT インフラストラクチャの包括的な可視性を提供するクラウドベースのインフラストラクチャ監視および分析プラットフォームです。

Data Infrastructure Insights は NetApp ストレージと VMware 環境の監視に重点を置いていることで知られていますが、他の種類のインフラストラクチャとワークロードを監視する機能も備えています。

NetApp Data Infrastructure Insights を使用して Libvirt ベースの仮想マシンを監視する方法は次のとおりです。

. データ収集者:
+
** Data Infrastructure Insights は、さまざまなデータ コレクターを使用してインフラストラクチャからデータを収集する Acquisition Unit ソフトウェアを通じて動作します。
** Data Infrastructure Insightsには、Kubernetesを含む異機種インフラストラクチャとワークロード向けのコレクターが搭載されています。また、オープンなTelegrafコレクターとオープンAPIも提供されており、他のシステムとの統合が容易です。


. Libvirt との潜在的な統合:
+
** カスタムデータ収集：オープンなTelegrafコレクターまたはData Infrastructure Insights APIを使用して、Libvirtベースのシステムからデータを収集することも可能です。ただし、LibvirtのAPI（virshコマンド経由、またはLibvirtの内部メトリクスへのアクセスなど）を使用してメトリクスを収集するようにコレクターを作成または設定する必要があります。


. Data Infrastructure Insights による Libvirt の監視の利点:
+
** 統合された可視性: NetApp ストレージと Libvirt ベースの VM の両方を含む仮想化環境の単一ビューを取得します。
** パフォーマンス監視: VM 内部の問題か、VM をサポートする基盤となるインフラストラクチャに関連する問題かを問わず、パフォーマンスのボトルネックとリソース制約を特定します。
** リソースの最適化: ワークロード プロファイルを分析して VM のサイズを適正化し、未使用のリソースを再利用し、環境全体でリソースの使用率を最適化します。
** トラブルシューティング: VM パフォーマンス メトリックとバックエンド ストレージ メトリックを相関させてエンドツーエンドの可視性を実現し、問題を迅速に特定して解決します。
** 予測分析: 機械学習を使用してインテリジェントな洞察を獲得し、パフォーマンスに影響する前に潜在的な問題を事前に特定します。




まとめると、Data Infrastructure InsightsはVMwareを強力にサポートしていますが、カスタムデータコレクターやオープンAPIを活用することで、Libvirtベースの仮想化環境と統合することも可能です。これにより、Data Infrastructure Insightsプラットフォーム内でLibvirt環境の統合的な可視性、強化されたパフォーマンス監視、そしてリソース最適化機能が提供されます。



== データ保護

NetApp ONTAPを使用したLibvirtベースの仮想マシンのデータ保護は、ONTAPに組み込まれたデータ保護機能を活用するなど、いくつかの方法で実現できます。一般的な戦略を以下にまとめます。

. ONTAP のネイティブ データ保護機能の使用:
+
** スナップショット：ONTAPの中核となるデータ保護テクノロジーはスナップショットです。スナップショットは、データボリュームの高速なポイントインタイムコピーであり、必要なディスク容量は最小限で、パフォーマンスオーバーヘッドもごくわずかです。スナップショットを使用することで、Libvirt VMディスクのバックアップを頻繁に作成できます（ただし、ディスクがONTAPボリュームに保存されている場合）。
** SnapMirror：SnapMirrorは、ONTAPストレージシステム間でSnapshotコピーを非同期的に複製するために使用されます。これにより、Libvirt VMのディザスタリカバリ（DR）コピーをリモートサイトまたはクラウドに作成できます。
** SnapVault：SnapVaultは、複数のストレージシステムから中央のONTAPシステムにデータをバックアップするために使用されます。これは、異なるホストにある多数のLibvirt VMのバックアップを中央のバックアップリポジトリに統合するのに適したオプションです。
** SnapRestore：SnapRestoreを使用すると、スナップショットコピーからデータを迅速に復元できます。これは、データの損失や破損が発生した場合にLibvirt VMを復旧するために不可欠です。
** FlexClone: FlexCloneは、スナップショットコピーに基づいてボリュームの書き込み可能なコピーを作成します。これは、本番環境のVMデータに基づいてテスト/開発環境を迅速に構築するのに役立ちます。
** MetroCluster/SnapMirror アクティブ同期: 自動化されたゼロ RPO (リカバリポイント目標) とサイト間の可用性のために、サイト間のストレッチ クラスタを可能にする ONTAP MetroCluster または SMas を使用できます。


. サードパーティ製バックアップソリューションとの統合：多くのサードパーティ製バックアップソリューションはNetApp ONTAPと統合され、仮想マシンのバックアップをサポートしています。これらのソリューションを使用することで、Libvirt仮想マシンをONTAPストレージにバックアップし、ONTAPのデータ保護機能を活用することができます。例えば、一部のバックアップソリューションは、ONTAPのスナップショットテクノロジーを使用して、高速なエージェントレスバックアップを実現しています。
. スクリプト作成と自動化：Libvirt VMボリュームのONTAPスナップショット作成プロセスを自動化するスクリプトを作成できます。これらのスクリプトは、ONTAPのコマンドラインインターフェースまたはAPIを活用してストレージシステムと対話できます。


重要な考慮事項:

* 保存場所: ONTAP のデータ保護機能を活用するには、Libvirt VM ディスク イメージを ONTAP ボリュームに保存する必要があります。
* ネットワーク接続: Libvirt ホストと ONTAP ストレージ システム間のネットワーク接続を確認します。
* HBA 管理: ストレージ接続にファイバー チャネル (FC) を使用する場合は、Libvirt ホストに必要な HBA 管理パッケージがインストールされていることを確認してください。
* 監視とレポート：データ保護操作を監視し、正常に完了していることを確認します。Libvirtの機能とONTAPの堅牢なデータ保護機能を組み合わせることで、仮想化環境に包括的なデータ保護戦略を実装できます。

