---
sidebar: sidebar 
permalink: vmware/vmw-dr-draas-vmfs.html 
keywords: dr, draas, bluexp, disaster recovery, vmfs datastore 
summary: このセクションでは、オンプレミスのVMware VMから別の指定されたサイトへのディザスタリカバリを設定するためのBlueXP  DRaaSの構成について説明します。 
---
= BlueXP  DRaaS for VMFSデータストアを使用したDR
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
本番サイトからディザスタリカバリサイトへのブロックレベルレプリケーションを使用したディザスタリカバリは、耐障害性に優れた対費用効果の高い方法で、サイトの停止やランサムウェア攻撃などのデータ破損からワークロードを保護します。NetApp SnapMirrorレプリケーションでは、VMFSデータストアを使用してオンプレミスのONTAPシステムで実行されているVMwareワークロードを、VMwareが配置されている指定のリカバリデータセンター内の別のONTAPストレージシステムにレプリケートできます。



== はじめに

このセクションでは、オンプレミスのVMware VMから別の指定されたサイトへのディザスタリカバリを設定するためのBlueXP  DRaaSの構成について説明します。このセットアップの一環として、BlueXP  アカウントであるBlueXP  ConnectorがBlueXP  ワークスペースに追加されました。これは、VMware vCenterからONTAPストレージへの通信を有効にするために必要なONTAPアレイです。また、サイト間のレプリケーションの設定方法、およびリカバリプランのセットアップとテスト方法についても詳しく説明します。最後のセクションでは、サイト全体のフェイルオーバーを実行する手順と、プライマリサイトがリカバリされてオンラインで購入された場合のフェイルバック方法について説明します。

NetApp BlueXP  コンソールに統合されたBlueXP  ディザスタリカバリサービスを使用すると、オンプレミスのVMware vCenterとONTAPストレージの検出、リソースグループの作成、ディザスタリカバリ計画の作成、リソースグループへの関連付け、フェイルオーバーとフェイルバックのテストまたは実行が可能になります。SnapMirrorは、ストレージレベルのブロックレプリケーションを提供し、増分変更によって2つのサイトを最新の状態に保ちます。その結果、RPOは最大5分になります。また、本番環境やレプリケートされたデータストアに影響を与えたり、追加のストレージコストをかけたりすることなく、DR手順を定期的にシミュレートすることもできます。BlueXP  ディザスタリカバリでは、ONTAPのFlexCloneテクノロジを利用して、DRサイトに最後にレプリケートされたSnapshotからVMFSデータストアのスペース効率に優れたコピーを作成します。DRテストが完了したら、お客様はテスト環境を削除するだけで、レプリケートされた実際の本番リソースに影響を与えることはありません。数回クリックするだけで、実際のフェイルオーバーが（計画的または計画外で）必要になった場合は、BlueXP  ディザスタリカバリサービスによって、指定されたディザスタリカバリサイトで保護対象の仮想マシンを自動的に起動するために必要なすべての手順がオーケストレーションされます。また、SnapMirror関係をプライマリサイトに反転し、必要に応じてフェイルバック処理のために変更をセカンダリからプライマリにレプリケートします。これらはすべて、他の有名な代替案と比較してわずかなコストで達成できます。

image:dr-draas-vmfs-image0.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]



== はじめに

BlueXP  ディザスタリカバリを開始するには、BlueXP  コンソールを使用してサービスにアクセスします。

. BlueXPにログインします。
. BlueXP  の左側のナビゲーションで、[Protection]>[Disaster Recovery]を選択します。
. BlueXP  ディザスタリカバリのダッシュボードが表示されます。


image:dr-draas-vmfs-image1.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

ディザスタリカバリプランを設定する前に、次の前提条件を満たしていることを確認してください。

* BlueXP  ConnectorはNetApp BlueXP  で設定されます。コネクタはAWS VPCに導入する必要があります。
* BlueXP  Connectorインスタンスが、ソースおよびデスティネーションのvCenterおよびストレージシステムに接続されている。
* VMware用のVMFSデータストアをホストするオンプレミスのNetAppストレージシステムは、BlueXP  に追加されます。
* DNS名を使用する場合は、DNS解決が実行されている必要があります。それ以外の場合は、vCenterのIPアドレスを使用します。
* SnapMirrorレプリケーションは、指定されたVMFSベースのデータストアボリュームに対して設定されます。


ソースサイトとデスティネーションサイトの間に接続が確立されたら、設定手順に進みます。所要時間は約3~5分です。


NOTE: NetAppでは、実際のシステム停止や自然災害時にBlueXP  Connectorがソースリソースとデスティネーションリソースとネットワーク経由で通信できるように、ディザスタリカバリサイトまたは第3のサイトにBlueXP  Connectorを導入することを推奨しています。

image:dr-draas-vmfs-image2.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: オンプレミスからオンプレミスへのVMFSデータストアのサポートは、本ドキュメントの作成中にテクノロジプレビュー段階にあります。この機能は、FCベースとiSCSIプロトコルベースの両方のVMFSデータストアでサポートされます。



== BlueXP  テイサスタリカハリセツテイ

ディザスタリカバリを準備するための最初のステップは、オンプレミスのvCenterリソースとストレージリソースを検出し、BlueXP  ディザスタリカバリに追加することです。


NOTE: キャンバス内の作業環境にONTAPストレージシステムが追加されていることを確認します。BlueXP  コンソールを開き、左側のナビゲーションから*[保護]>[ディザスタリカバリ]*を選択します。[Discover vCenter servers（vCenterサーバの検出）]*を選択するか、トップメニューで*[Sites（サイト）]>[Add（追加）]>[Add vCenter（vCenterの追加）]

image:dr-draas-vmfs-image3.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

次のプラットフォームを追加します。

* *ソース*。オンプレミスのvCenter：


image:dr-draas-vmfs-image4.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

* *デスティネーション*。VMC SDDC vCenter：


image:dr-draas-vmfs-image5.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

vCenterが追加されると、自動検出がトリガーされます。



== ソースサイトとデスティネーションサイト間のストレージレプリケーションの設定

SnapMirrorでは、ONTAPスナップショットを使用して、ある場所から別の場所へのデータ転送を管理します。最初に、ソースボリュームのSnapshotに基づくフルコピーがデスティネーションにコピーされ、ベースライン同期が実行されます。ソースでデータが変更されると、新しいSnapshotが作成され、ベースラインSnapshotと比較されます。変更されたブロックがデスティネーションにレプリケートされ、新しいSnapshotが現在のベースラインまたは最も新しい共通のSnapshotになります。これにより、プロセスを繰り返し、差分更新をデスティネーションに送信できます。

SnapMirror関係が確立されると、デスティネーションボリュームはオンラインの読み取り専用状態になり、引き続きアクセスできます。SnapMirrorは、ファイルレベルやその他の論理レベルではなく、ストレージの物理ブロックと連携します。つまり、デスティネーションボリュームはソースと同じレプリカであり、Snapshotやボリューム設定などが含まれます。データ圧縮やデータ重複排除などのONTAPのスペース効率化機能がソースボリュームで使用されている場合、レプリケートされたボリュームでもこれらの最適化が維持されます。

SnapMirror関係を解除するとデスティネーションボリュームが書き込み可能になり、SnapMirrorを使用してDR環境とデータを同期している場合は通常、フェイルオーバーの実行に使用されます。SnapMirrorは高度な機能を備えているため、フェイルオーバーサイトで変更されたデータをプライマリシステムに効率的に再同期して、あとでオンラインに戻ってから元のSnapMirror関係を再確立できます。



== VMwareディザスタリカバリ用のセットアップ方法

SnapMirrorレプリケーションの作成プロセスは、どのアプリケーションでも同じです。プロセスは手動でも自動でもかまいません。最も簡単な方法は、BlueXP  を活用してSnapMirrorレプリケーションを設定する方法です。環境内のソースONTAPシステムをデスティネーションにドラッグアンドドロップするだけで、残りのプロセスをウィザードで実行できます。

image:dr-draas-vmfs-image6.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

BlueXP  DRaaSでは、次の2つの基準が満たされていれば、同じことを自動化することもできます。

* ソースクラスタとデスティネーションクラスタにピア関係が確立されています。
* ソースSVMとデスティネーションSVMのピア関係が確立されています。


image:dr-draas-vmfs-image7.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: CLIを使用してボリュームに対してSnapMirror関係がすでに設定されている場合、BlueXP  DRaaSは関係をピックアップし、残りのワークフロー操作を続行します。


NOTE: 上記のアプローチとは別に、ONTAP CLIまたはシステムマネージャを使用してSnapMirrorレプリケーションを作成することもできます。SnapMirrorを使用してデータを同期する方法に関係なく、BlueXP  DRaaSはワークフローをオーケストレーションし、シームレスで効率的なディザスタリカバリ処理を実現します。



== BlueXP  ディザスタリカバリにはどのようなメリットがありますか？

ソースサイトとデスティネーションサイトが追加されると、BlueXP  ディザスタリカバリによって詳細な自動検出が実行され、VMと関連するメタデータが表示されます。BlueXP  ディザスタリカバリでは、VMで使用されているネットワークとポートグループも自動的に検出されて読み込まれます。

image:dr-draas-vmfs-image8.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

サイトを追加したら、VMをリソースグループにグループ化できます。BlueXP  ディザスタリカバリリソースグループを使用すると、依存するVMのセットを論理グループにグループ化できます。論理グループには、リカバリ時に実行できるブート順序とブート遅延が含まれます。リソースグループの作成を開始するには、*[リソースグループ]*に移動し、*[新しいリソースグループの作成]*をクリックします。

image:dr-draas-vmfs-image9.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: リソースグループは、レプリケーション計画の作成時に作成することもできます。

シンプルなドラッグアンドドロップメカニズムを使用して、リソースグループの作成時にVMのブート順序を定義または変更できます。

image:dr-draas-vmfs-image10.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

リソースグループを作成したら、次のステップでは、災害発生時に仮想マシンとアプリケーションをリカバリするための実行計画または計画を作成します。前提条件で説明したように、SnapMirrorレプリケーションは事前に構成することも、DRaaSはレプリケーション計画の作成時に指定したRPOと保持数を使用して構成することもできます。

image:dr-draas-vmfs-image11.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

image:dr-draas-vmfs-image12.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

レプリケーション計画を設定するには、ドロップダウンからソースとデスティネーションのvCenterプラットフォームを選択し、計画に含めるリソースグループを選択します。また、アプリケーションのリストア方法と電源投入方法のグループ化、クラスタとネットワークのマッピングも選択します。リカバリプランを定義するには、*[レプリケーションプラン]*タブに移動し、*[プランの追加]*をクリックします。

最初にソースvCenterを選択し、次にデスティネーションvCenterを選択します。

image:dr-draas-vmfs-image13.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

次の手順では、既存のリソースグループを選択します。リソースグループが作成されていない場合は、ウィザードを使用して、リカバリ目標に基づいて必要な仮想マシンをグループ化（基本的に機能的なリソースグループを作成）できます。これは、アプリケーション仮想マシンのリストア方法のオペレーションシーケンスの定義にも役立ちます。

image:dr-draas-vmfs-image14.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: リソースグループでは'ドラッグアンドドロップ機能を使用してブート順序を設定できますこれを使用すると、リカバリプロセス中にVMの電源をオンにする順序を簡単に変更できます。


NOTE: リソースグループ内の各仮想マシンは、順序に基づいて順番に起動されます。2つのリソースグループが並行して開始されます。

以下のスクリーンショットは、リソースグループを事前に作成していない場合に、組織の要件に基づいて仮想マシンまたは特定のデータストアをフィルタリングするオプションを示しています。

image:dr-draas-vmfs-image15.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

リソースグループを選択したら、フェイルオーバーマッピングを作成します。この手順では、ソース環境のリソースをデスティネーションにマッピングする方法を指定します。これには、コンピューティングリソースや仮想ネットワークが含まれます。IPカスタマイズ、プリスクリプトとポストスクリプト、ブート遅延、アプリケーションの整合性など。詳細については、を参照してくださいlink:https://docs.netapp.com/us-en/bluexp-disaster-recovery/use/drplan-create.html#map-source-resources-to-the-target["レプリケーション計画の作成"]。

image:dr-draas-vmfs-image16.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]


NOTE: デフォルトでは、テスト処理とフェイルオーバー処理の両方に同じマッピングパラメータが使用されます。テスト環境に異なるマッピングを適用するには、チェックボックスをオフにしたあとに、次のように[Test mapping]オプションを選択します。

image:dr-draas-vmfs-image17.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

リソースのマッピングが完了したら、[Next]をクリックします。

image:dr-draas-vmfs-image18.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

繰り返しタイプを選択します。簡単に言えば、[Migrate]（フェイルオーバーを使用した1回限りの移行）または[Recurring Continuous Replication]オプションを選択します。このチュートリアルでは、[複製]オプションが選択されています。

image:dr-draas-vmfs-image19.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

完了したら、作成したマッピングを確認し、[Add plan]をクリックします。

image:dr-draas-vmfs-image20.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

image:dr-draas-vmfs-image21.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

レプリケーション計画が作成されたら、フェイルオーバーオプション、テストフェイルオーバーオプション、または移行オプションを選択して、要件に応じてフェイルオーバーを実行できます。BlueXP  のディザスタリカバリでは、レプリケーションプロセスが計画に従って30分ごとに実行されます。フェイルオーバーオプションとテストフェイルオーバーオプションでは、最新のSnapMirror Snapshotコピーを使用するか、（SnapMirrorの保持ポリシーに基づいて）ポイントインタイムSnapshotコピーから特定のSnapshotコピーを選択できます。ポイントインタイムオプションは、最新のレプリカがすでに侵害または暗号化されているランサムウェアなどの破損イベントが発生した場合に非常に役立ちます。BlueXP  ディザスタリカバリには、使用可能なリカバリポイントがすべて表示されます

image:dr-draas-vmfs-image22.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

レプリケーションプランで指定した構成でフェイルオーバーまたはテストフェイルオーバーをトリガーするには、* Failover *または* Test failover *をクリックします。

image:dr-draas-vmfs-image23.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]



== フェイルオーバーまたはテストフェイルオーバーの処理中はどうなりますか？

テストフェイルオーバー処理中は、BlueXP  ディザスタリカバリによって、最新のSnapshotコピーまたはデスティネーションボリュームの選択したSnapshotを使用して、デスティネーションONTAPストレージシステムにFlexCloneボリュームが作成されます。


NOTE: テストフェイルオーバー処理では、デスティネーションONTAPストレージシステムにクローンボリュームを作成します。


NOTE: テストリカバリ処理を実行しても、SnapMirrorレプリケーションには影響しません。

image:dr-draas-vmfs-image24.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

このプロセスでは、BlueXP  ディザスタリカバリは元のターゲットボリュームをマッピングしません。代わりに、選択したSnapshotから新しいFlexCloneが作成され、FlexCloneボリュームの基盤となる一時的なデータストアがESXiホストにマッピングされます。

image:dr-draas-vmfs-image25.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

image:dr-draas-vmfs-image26.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

テストフェイルオーバー処理が完了したら、*「Clean up failover test」*を使用してクリーンアップ処理を開始できます。この処理では、BlueXP  ディザスタリカバリによって、処理に使用されていたFlexCloneボリュームが削除されます。

実際に災害が発生した場合、BlueXP  ディザスタリカバリは次の手順を実行します。

. サイト間のSnapMirror関係を解除します。
. 再署名後すぐに使用できるようにVMFSデータストアボリュームをマウントします。
. VMの登録
. VMの電源をオンにする


image:dr-draas-vmfs-image27.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

プライマリサイトの運用が開始されると、BlueXP  ディザスタリカバリによってSnapMirrorの逆再同期とフェイルバックが可能になり、ボタンをクリックするだけで再度実行できます。

image:dr-draas-vmfs-image28.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

また、移行オプションが選択されている場合は、計画的フェイルオーバーイベントとみなされます。この場合は、ソースサイトで仮想マシンをシャットダウンする追加の手順がトリガーされます。残りの手順はフェイルオーバーイベントと同じです。

BlueXP  またはONTAP CLIから、該当するデータストアボリュームのレプリケーションヘルスステータスを監視できます。また、フェイルオーバーまたはテストフェイルオーバーのステータスは、ジョブ監視を使用して追跡できます。

image:dr-draas-vmfs-image29.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

これにより、カスタマイズされたディザスタリカバリ計画を処理するための強力なソリューションが提供されます。フェイルオーバーは、計画的フェイルオーバーまたはフェイルオーバーとして実行できます。災害発生時にDRサイトのアクティブ化が決定した場合は、ボタンをクリックするだけで実行できます。

このプロセスの詳細については、詳細なウォークスルービデオに従うか、を使用してくださいlink:https://netapp.github.io/bluexp-draas-vmfs-simulator/?frame-0.1["ソリューションシミュレータ"]。
