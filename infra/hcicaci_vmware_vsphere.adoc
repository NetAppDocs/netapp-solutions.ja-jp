---
sidebar: sidebar 
permalink: infra/hcicaci_vmware_vsphere.html 
keywords: VMware vSphere, virtualization, workflow, ESXi, vCenter 
summary: TR-4857 
---
= VMware vSphere ： NetApp HCI と Cisco ACI
:hardbreaks:
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/


[role="lead"]
VMware vSphere は、耐障害性と信頼性に優れた仮想インフラストラクチャを構築するための、業界をリードする仮想化プラットフォームです。vSphere には、仮想化レイヤ、管理レイヤ、インターフェイスレイヤがあります。VMware vSphere の中核となるコンポーネントは、 ESXi サーバと vCenter Server の 2 つです。VMware ESXi は、 VM と仮想アプライアンスのホストを容易にするために物理マシンにインストールされるハイパーバイザーソフトウェアです。vCenter Server は、ネットワークで接続された複数の ESXi ホストを管理してホストリソースをプールするためのサービスです。VMware vSphere の詳細については、のドキュメントを参照してください https://docs.vmware.com/en/VMware-vSphere/index.html["こちらをご覧ください"^]。



== ワークフロー

次のワークフローを使用して仮想環境を構成しました。それぞれの手順で、複数のタスクを実行する必要があります。

. UCS C シリーズサーバに Nexus 9000 スイッチを ACI モードで、 APIC ソフトウェアをインストールして設定します。インストールとアップグレードを参照してください https://www.cisco.com/c/en/us/support/cloud-systems-management/application-policy-infrastructure-controller-apic/tsd-products-support-series-home.html["ドキュメント"^] を参照してください。
. を参照して ACI ファブリックの設定とセットアップを行います https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/apic/sw/3-x/getting_started/b_APIC_Getting_Started_Guide_Rel_3_x.html["ドキュメント"^]。
. NetApp HCI ノードに必要なテナント、アプリケーションプロファイル、ブリッジドメイン、および PG を設定します。iSCSI を除き、 BD to One EPG フレームワークを 1 つ使用することを推奨します。のドキュメントを参照してください https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/apic/sw/2-x/L2_config/b_Cisco_APIC_Layer_2_Configuration_Guide.html["こちらをご覧ください"^] 詳細：必要な EPG の最小セットは、帯域内管理、 iSCSI 、 iSCSI-A 、 iSCSI-B 、 VM モーションです。 VM データネットワークとネイティブ。
+

NOTE: iSCSI マルチパスには、 iSCSI-A と iSCSI-B の 2 つの iSCSI PG が必要です。それぞれに 1 つのアクティブアップリンクが必要です。

+

NOTE: ネットアップ管理ノードには、両方のアップリンクがアクティブな iSCSI EPG が必要です。

. 要件に基づいて、 VLAN プール、物理ドメイン、および AEP を作成します。個々のポートのスイッチプロファイルとインターフェイスプロファイルを作成します。次に、物理ドメインを接続し、静的パスを EPG に設定します。を参照してください https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/apic/sw/2-x/L2_config/b_Cisco_APIC_Layer_2_Configuration_Guide.html["コンフィギュレーションガイド"^] 詳細：
+
image:hcicaci_image6.png["エラー：グラフィックイメージがありません"]

+
image:hcicaci_image7.png["エラー：グラフィックイメージがありません"]

+

NOTE: NetApp HCI コンピューティングノードに接続するインターフェイスにはアクセスポートポリシーグループを使用し、 NetApp HCI ストレージノードへのインターフェイスには vPC ポリシーグループを使用します。

. ワークロード間のアクセスを厳密に制御するための契約を作成して割り当てます。契約の設定の詳細については、ガイドを参照してください https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/apic/sw/1-x/Operating_ACI/guide/b_Cisco_Operating_ACI/b_Cisco_Operating_ACI_chapter_01000.html["こちらをご覧ください"^]。
. NDE を使用して NetApp HCI をインストールおよび設定する。ネットワーク用の VDS ポートグループを含む、必要なすべてのパラメータが設定され、 mNode VM もインストールされます。を参照してください https://docs.netapp.com/hci/index.jsp["導入ガイド"^] を参照してください。
. VMM と VMware VDS を組み合わせた Cisco ACI の統合はオプションですが、 VMM 統合機能を使用することがベストプラクティスです。VMM 統合を使用しない場合は、 NDE がインストールされた VDS を Cisco ACI の物理ドメイン添付ファイルを使用してネットワーク接続に使用できます。
. VMM 統合を使用している場合、 NDE がインストールした VDS は ACI で完全に管理できず、読み取り専用 VMM ドメインとして追加できます。このようなシナリオを回避し、 Cisco ACI の VMM ネットワーク機能を効率的に使用するには、新しい VMware vSphere Distributed Switch （ vDS ）と明示的な動的 VLAN プールを使用して、 ACI で新しい VMware VMM ドメインを作成します。作成された VMM ドメインは、サポートされている任意の仮想スイッチと統合できます。
+
.. * VDS と統合。 * ACI と VDS を統合する場合は、仮想スイッチのタイプとして VMware Distributed Switch を選択します。次の表に示す構成のベストプラクティスを考慮してください。を参照してください https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/apic/sw/3-x/virtualization/Cisco-ACI-Virtualization-Guide-3-2-x/Cisco-ACI-Virtualization-Guide-3-2-x_chapter_011.html["コンフィギュレーションガイド"^] 詳細：
+
image:hcicaci_image8.png["エラー：グラフィックイメージがありません"]

.. *Integrate with Cisco AVE. * Cisco AVE を Cisco ACI に統合する場合は、 Cisco AVE にする仮想スイッチのタイプを選択します。Cisco AVE では、内部ポートグループと外部ポートグループ間の通信に、 Internal タイプの一意の VLAN プールが必要です。この表に記載されている構成のベストプラクティスに従ってください。を参照してください https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/aci_virtual_edge/installation_upgrade/2-x/Cisco-ACI-Virtual-Edge-Installation-Guide-201.html["インストールガイド"^] Cisco AVE をインストールして設定するには、次の手順を実行
+
image:hcicaci_image9.png["エラー：グラフィックイメージがありません"]

+
image:hcicaci_image10.png["エラー：グラフィックイメージがありません"]



. Pre-Provision Resolution 即時性を使用して、 VMM ドメインを EPG に接続します。次に、 NDE が作成した VDS からすべての VMNIC 、 VMkernel ポート、 VNIC を ACI によって作成された VDS や AVE に移行します。iSCSI-A と iSCSI-B のアップリンクのフェイルオーバーとチーミングポリシーを、それぞれ 1 つのアクティブアップリンクに設定します。VM から ACI によって作成されたポートグループに VMNIC を接続して、ネットワークリソースにアクセスできるようになりました。Cisco ACI によって管理される VDS 上のポートグループは、「 <tenant-name> | <application-profile-name> | <EPG-name> 」の形式になります。
+

NOTE: VMM コントローラが仮想スイッチに接続される前でも、リーフスイッチにポートポリシーが確実にダウンロードされるようにするには、事前プロビジョニング解決の即時性が必要です。

+
image:hcicaci_image11.png["エラー：グラフィックイメージがありません"]

+
image:hcicaci_image12.png["エラー：グラフィックイメージがありません"]

. マイクロセグメンテーションを使用する場合は、右 BD にマイクロセグメント（ uSeg ） EPG を取り付けます。VMware vSphere で属性を作成し、必要な VM に接続します。VMM ドメインで Enable Tag Collection が有効になっていることを確認します。対応する属性を使用して uSeg EPG を設定し、 VMM ドメインをその属性に接続します。これにより、エンドポイント VM の通信をより細かく制御できます。
+
image:hcicaci_image13.png["エラー：グラフィックイメージがありません"]

+
この解決策の NetApp HCI 上の VMware vSphere のネットワーク機能は、 VMware VDS または Cisco AVE を使用して提供されます。





=== VMware VDS

VMware vSphere Distributed Switch （ VDS ）は、クラスタ内またはクラスタセット内の複数の ESXi ホストに接続する仮想スイッチです。仮想マシンは、複数のホストに移行する際に一貫したネットワーク設定を維持できます。VDS を使用すると、 vSphere 環境でネットワーク構成を一元管理することもできます。詳細については、を参照してください https://www.vmware.com/in/products/vsphere/distributed-switch.html["VDS のドキュメント"^]。

image:hcicaci_image14.png["エラー：グラフィックイメージがありません"]

次の表に、 Cisco ACI と VMware VDS を設定して統合する際に必要なパラメータとベストプラクティスを示します。

|===
| リソース | 構成に関する考慮事項 | ベストプラクティス 


| エンドポイントグループ  a| 
* ネイティブ VLAN 用の個別の EPG
* ネイティブ VLAN EPG の HCI ストレージノードおよびコンピューティングノードへのインターフェイスの静的バインディングは、 802.1P モードを使用します。これは、ノード検出で NDE を実行するために必要です。
* iSCSI 、 iSCSI-A 、および iSCSI-B の各 EPG を共通の BD で分離します
* iSCSI-A と iSCSI-B は iSCSI マルチパス用で、使用されます ESXi ホストの VMkernel ポートの場合
* 実行前に iSCSI EPG に接続する物理ドメイン NDE
* iSCSI 、 iSCSI-A 、および iSCSI-B の各 EPG に接続される VMM ドメイン

 a| 
* EPG 間の契約を明確に定義する。通信に必要なポートのみを許可します。
* NDE のノード検出に一意のネイティブ VLAN を使用します
* VMkernel ポートに接続されているポートグループに対応する EPG の場合、 VMM ドメインは、即時の解決のための事前プロビジョニングで接続されます




| インターフェイスポリシー  a| 
* すべての ESXi の共通リーフアクセスポートポリシーグループ ホスト
* NetApp HCI ストレージノードごとに 1 つの vPC ポリシーグループ
* LLDP が有効、 CDP が無効

 a| 
* ダイナミック割り当てを有効にして VMM ドメインの VLAN プールを分離します オン
* では、 LACP アクティブポートチャネルポリシーで vPC を使用することを推奨します NetApp HCI ストレージノードへのインターフェイス
* コンピューティングノードには個別のインターフェイスを使用し、 LACP は使用しないことを推奨します。




| VMM の統合  a| 
* ローカルスイッチングの優先順位
* アクセスモードは読み取り / 書き込みです。

 a| 
* MAC-Pining-Physical-NIC- vSwitch ポリシーのロード
* 検出ポリシーの LLDP
* マイクロセグメンテーションを使用する場合は、タグの収集を有効にします




| VDS  a| 
* 両方のアップリンクが iSCSI ポートグループに対してアクティブです
* iSCSI-A と iSCSI-B ごとに 1 つのアップリンク

 a| 
* すべてのポートグループを「ルートベース」にするためのロードバランシング方式 物理 NIC 負荷時
* iSCSI VMkernel ポートを移行して、一度に 1 つずつ移行します NDE が VDS を ACI 統合 VDS に導入したからの時間




| 拡張が容易  a| 
* 同じリーフアクセスポートを接続して NDE スケールを実行します 追加する ESXi ホストのポリシーグループを指定します
* NetApp HCI ストレージノードごとに 1 つの vPC ポリシーグループ
* NDE の拡張を成功させるには、個々のインターフェイス（ ESXi ホストの場合）と vPC （ストレージノードの場合）をネイティブのインバンド管理、 iSCSI 、 VM モーションの各 PG に接続する必要があります
* LLDP が有効、 CDP が無効

 a| 
* では、 LACP アクティブポートチャネルポリシーで vPC を使用することを推奨します NetApp HCI ストレージノードへのインターフェイス
* コンピューティングノードには個別のインターフェイスを使用し、 LACP は使用しないことを推奨します。


|===

NOTE: トラフィックのロードバランシングでは、 vPC を使用したポートチャネルを、アクティブモードの VDS 上の LAG とともに Cisco ACI で使用できます。ただし、 iSCSI マルチパスと比較すると、 LACP を使用するとストレージのパフォーマンスに影響する可能性があります。



=== Cisco AVE

Cisco ACI Virtual Edge （ AVE ）は、 Cisco ACI ポリシーモデルを仮想インフラに拡張する、 Cisco によって提供される仮想スイッチです。ハイパーバイザーのネイティブ仮想スイッチの上に配置される、ハイパーバイザーに依存しない分散ネットワークサービスです。VM ベースの解決策を使用する基盤の仮想スイッチを活用して、仮想環境をネットワークで可視化します。Cisco AVE の詳細については、を参照してください https://www.cisco.com/c/en/us/products/switches/application-centric-infrastructure-virtual-edge/index.html["ドキュメント"^]。次の図は、テストで使用した ESXi ホスト上の Cisco AVE の内部ネットワークを示しています。

image:hcicaci_image15.png["エラー：グラフィックイメージがありません"]

次の表に、 VMware ESXi で Cisco ACI と Cisco AVE の設定と統合に必要なパラメータとベストプラクティスを示します。Cisco AVE は現在、 VMware vSphere でのみサポートされています。

|===
| リソース | 構成に関する考慮事項 | ベストプラクティス 


| エンドポイントグループ  a| 
* ネイティブ VLAN 用の個別の EPG
* ネイティブ VLAN EPG の HCI ストレージノードおよびコンピューティングノードへのインターフェイスの静的バインディングは、 802.1P モードを使用します。これは、ノード検出で NDE を実行するために必要です。
* iSCSI 、 iSCSI-A 、および iSCSI-B の各 EPG を共通の BD で分離します
* iSCSI-A と iSCSI-B は iSCSI マルチパス用で、使用されます ESXi ホストの VMkernel ポートの場合
* 実行前に iSCSI EPG に接続する物理ドメイン NDE
* VMM ドメインは、 iSCSI 、 iSCSI-A 、および iSCSI-B の各 EPG に接続されます

 a| 
* ダイナミック割り当てを有効にして VMM ドメインの VLAN プールを分離します オン
* EPG 間の契約を明確に定義する。通信に必要なポートのみを許可します。
* NDE のノード検出に一意のネイティブ VLAN を使用します
* VMM ドメインのネイティブスイッチングモードは、それを含む EPG に使用します ホストの VMkernel アダプタに接続されているポートグループに対応します
* 対応する EPG には VMM ドメインの AVE スイッチングモードを使用します ユーザ VM トラフィックを伝送するポートグループへ
* VMkernel ポートに接続されているポートグループに対応する EPG の場合、 VMM ドメインは、即時の解決のための事前プロビジョニングを使用して接続されます




| インターフェイスポリシー  a| 
* NetApp HCI ストレージノードごとに 1 つの vPC ポリシーグループ
* LLDP が有効、 CDP が無効
* NDE 検出を実行する前に、次の手順を実行します。
+
** すべての ESXi ホストのリーフアクセスポートポリシーグループ


* NDE を実行した後の Cisco AVE の場合：
+
** ESXi ホストごとに 1 つの vPC ポリシーグループ



 a| 
* Cisco AVE の場合は、 vPC を使用して ESXi ホストに接続することを推奨します
* vPC と ESXi のポートチャネルポリシーでスタティックモードを使用します
* ポートチャネルにレイヤ 4 SRC ポートロードバランシングハッシュ方式を使用します ポリシー
* ネットアップでは、 LACP のアクティブポートチャネルポリシーで vPC を使用することを推奨します NetApp HCI ストレージノードへのインターフェイス




| VMM の統合  a| 
* ロールを持つ新しい VLAN 範囲（または Encap Block ）を作成します VLAN プールに接続された内部割り当ておよび動的割り当て VMM ドメインの場合
* マルチキャストアドレスのプールを作成します（各 EPG に 1 つのアドレス）。
* マルチキャストのプールとは異なる別のマルチキャストアドレスを予約します AVE ファブリック全体のマルチキャストアドレス用のアドレス
* ローカルスイッチングの優先順位
* 読み取り / 書き込みモードにするアクセスモード

 a| 
* vSwitch ポリシーの静的モード
* vSwitch ポートチャネルポリシーとインターフェイスポリシーグループのポートチャネルを確認します ポリシーが同じモードを使用しています
* 検出ポリシーの LLDP
* マイクロセグメンテーションを使用する場合は、タグ収集を有効にします
* デフォルトエンキャップモードの推奨オプションは VXLAN です




| VDS  a| 
* 両方のアップリンクが iSCSI ポートグループに対してアクティブです
* iSCSI-A と iSCSI-B ごとに 1 つのアップリンク

 a| 
* iSCSI VMkernel ポートの移行は、一度に 1 つずつ実行します NDE が導入する VDS から ACI 統合 VDS へ
* すべてのポートグループをルートベースにするためのロードバランシング方式 IP ハッシュ上




| Cisco AVE  a| 
* アクセスポートインターフェイスポリシーグループを使用して、 NDE を ESXi ホストに対して実行します。NDE を正常に実行するには、 ESXi ホストへの個々のインターフェイスをネイティブのインバンド管理、 iSCSI 、 VM モーションの各 PG に接続する必要があります。
* 環境が稼働したら、ホストをメンテナンスモードにし、スタティックモードをオンにした状態でインターフェイスポリシーグループを vPC に移行し、必要なすべての EPG に vPC を割り当てて、ホストをメンテナンスモードから削除します。すべてのホストについて、同じ手順を繰り返します。
* AVE インストールプロセスを実行して AVE 制御 VM をインストールします すべてのホスト

 a| 
* AVE 制御 VM のインストールには、ホスト上のローカルデータストアを使用します。各ホストには、 1 つの AVE 制御 VM がインストールされている必要があります それ
* 場合によっては、インバンド管理 VLAN でネットワークプロトコルプロファイルを使用します そのネットワークでは DHCP を使用できません




| 拡張が容易  a| 
* 追加する ESXi ホストのアクセスポートインターフェイスポリシーグループで NDE 拡張を実行します。NDE を正常に実行するには、個々のインターフェイスをネイティブのインバンド管理、 iSCSI 、 VM モーション EPG に接続する必要があります。
* * ESXi ホストが vSphere クラスタに追加されたら、ホストをメンテナンスモードにし、インターフェイスポリシーグループを静的モードをオンにした vPC に移行します。次に、 vPC を必要な EPG.* に接続します
* インストールする新しいホストで AVE インストールプロセスを実行します そのホスト上の Ave コントロール VM
* NetApp HCI ストレージノードごとに 1 つの vPC ポリシーグループをに割り当てます をクラスタに追加します
* LLDP が有効、 CDP が無効

 a| 
* ホスト上のローカルデータストアを使用して AVE コントロールをインストールします VM
* 場合によっては、インバンド管理 VLAN でネットワークプロトコルプロファイルを使用します そのネットワークでは DHCP を使用できません
* では、 LACP アクティブポートチャネルポリシーで vPC を使用することを推奨します NetApp HCI ストレージノードへのインターフェイス


|===

NOTE: トラフィックのロードバランシングでは、ポートチャネルと vPC を使用して、 ESXi ホスト上の LAG とともに Cisco ACI でアクティブモードの LACP で使用できます。ただし、 iSCSI マルチパスと比較すると、 LACP を使用するとストレージのパフォーマンスに影響する可能性があります。

link:hcicaci_RHV.html["次の例： Red Hat Virtualization ： NetApp HCI with Cisco ACI"]
