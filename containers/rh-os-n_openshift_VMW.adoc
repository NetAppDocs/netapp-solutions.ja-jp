---
sidebar: sidebar 
permalink: containers/rh-os-n_openshift_VMW.html 
keywords: OpenShift, VMware vSphere, ESXi 
summary: VMware vSphere は、 ESXi ハイパーバイザー上で実行される多数の仮想サーバとネットワークを一元管理するための仮想化プラットフォームです。 
---
= VMware vSphere 上の OpenShift
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/


[role="lead"]
VMware vSphere は、 ESXi ハイパーバイザー上で実行される多数の仮想サーバとネットワークを一元管理するための仮想化プラットフォームです。

VMware vSphere の詳細については、を参照してください link:https://www.vmware.com/products/vsphere.html["VMware vSphere の Web サイト"^]。

VMware vSphere には次の機能があります。

* * VMware vCenter Server* VMware vCenter Server は、 1 つのコンソールからすべてのホストと VM を統合管理し、クラスタ、ホスト、 VM のパフォーマンス監視を集約します。
* * VMware vSphere vMotion * VMware vCenterを使用すると、要求に応じて、システムを停止せずにクラスタ内のノード間でVMをホット移行できます。
* * vSphere High Availability *ホスト障害時のシステム停止を回避するために、VMware vSphereではホストをクラスタ化し、高可用性を実現できるように構成できます。ホストの障害によってシステムが停止した VM は、クラスタ内の他のホストでまもなくリブートされ、サービスがリストアされます。
* * Distributed Resource Scheduler（DRS）* VMware vSphereクラスタは、ホストしているVMのリソースニーズを負荷分散するように設定できます。リソース競合のある VM は、十分なリソースを使用できるように、クラスタ内の他のノードにホット移行できます。


image:redhat_openshift_image33.png["エラー：グラフィックイメージがありません"]



== ネットワーク設計

NetApp 解決策上の Red Hat OpenShift では、 2 つのデータスイッチを使用して 25Gbps でプライマリデータ接続を提供します。また、ストレージノードのインバンド管理用に 1Gbps で接続を提供する管理スイッチをさらに 2 台使用し、 IPMI 機能のアウトオブバンド管理も行います。OCP のクラスタ管理には、 VMware vSphere 上の VM 論理ネットワークが使用されます。このセクションでは、解決策で使用される各仮想ネットワークセグメントの配置と目的について説明し、解決策を導入するための前提条件について説明します。



=== VLAN の要件

VMware vSphere 上の Red Hat OpenShift は、仮想ローカルエリアネットワーク（ VLAN ）を使用して、ネットワークトラフィックを論理的に分離するように設計されています。この構成は、お客様のニーズに合わせて拡張することも、特定のネットワークサービスをさらに分離することもできます。次の表に、ネットアップで解決策を検証する際に解決策を実装するために必要な VLAN を示します。

[cols="40%, 40%, 20%"]
|===
| VLAN | 目的 | VLAN ID 


| アウトオブバンド管理ネットワーク | 物理ノードと IPMI の管理 | 16 


| VM ネットワーク | 仮想ゲストネットワークアクセス | 181 


| ストレージネットワーク | ONTAP NFS 用のストレージネットワーク | 184 


| ストレージネットワーク | ONTAP iSCSI 用のストレージネットワーク | 185 


| インバンド管理ネットワーク | ESXi ノード、 vCenter Server 、 ONTAP Select の管理 | 3480 


| ストレージネットワーク | NetApp Element iSCSI 用のストレージネットワーク | 3481 


| 移行用ネットワーク | 仮想ゲスト移行用のネットワーク | 3487 
|===


=== ネットワークインフラストラクチャサポートリソース

OpenShift Container Platform を導入する前に、次のインフラを用意する必要があります。

* インバンド管理ネットワークと VM ネットワークからアクセス可能な完全なホスト名解決を提供する DNS サーバが少なくとも 1 台必要です。
* インバンド管理ネットワークおよび VM ネットワークからアクセスできる NTP サーバが少なくとも 1 台必要です。
* （オプション）インバンド管理ネットワークと VM ネットワークの両方のアウトバウンドインターネット接続。




== 本番環境の導入に関するベストプラクティス

このセクションでは、この解決策を本番環境に導入する前に考慮する必要があるベストプラクティスをいくつか紹介します。



=== 少なくとも 3 つのボリュームからなる ESXi クラスタに OpenShift を導入します ノード

本ドキュメントで説明する検証済みのアーキテクチャには、 VMware vSphere HA と VMware vMotion を有効にして、 2 つの ESXi ハイパーバイザーノードを導入し、フォールトトレラント構成を確保することで、 HA 処理に適した最小限のハードウェア環境が示されています。この構成では、導入した VM を 2 つのハイパーバイザー間で移行し、 1 つのホストが使用できなくなった場合にリブートすることができます。

Red Hat OpenShift では最初に 3 つのマスターノードを導入するため、 2 ノード構成の少なくとも 2 つのマスターが同じノードを占有することがあります。その場合、特定のノードが使用できなくなったときに OpenShift が停止する可能性があります。そのため、 Red Hat のベストプラクティスでは、 OpenShift マスターを均等に分散してフォールトトレランスを高めるために、少なくとも 3 つの ESXi ハイパーバイザーノードを導入する必要があります。



=== 仮想マシンとホストのアフィニティを設定します

VM とホストのアフィニティを有効にすることで、複数のハイパーバイザーノードに OpenShift マスターを確実に分散させることができます。

アフィニティまたは非アフィニティは、 VM やホストのセットに対してルールを定義する方法で、グループ内の同じホストまたはホスト上で VM を一緒に実行するか、別のホスト上で実行するかを決定します。VM とホストで構成されるアフィニティグループを作成することで、 VM に適用されます。このアフィニティグループには同じパラメータと条件が設定されます。アフィニティグループ内の VM がグループ内の同じホストで実行されているのか、または別々のホストで実行されているのかに応じて、アフィニティグループのパラメータでは正のアフィニティまたは負のアフィニティを定義できます。

アフィニティグループを設定するには、を参照してください link:https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.resmgmt.doc/GUID-FF28F29C-8B67-4EFF-A2EF-63B3537E6934.html["vSphere 6.7 ドキュメント：「 DRS アフィニティルールの使用"^]。



=== OpenShift 環境にカスタムインストールファイルを使用します

IPI を使用すると、このドキュメントで前述した対話型ウィザードを使用して、 OpenShift クラスタを簡単に導入できます。ただし、クラスタ導入の一環として、一部のデフォルト値の変更が必要になる場合があります。

このような場合は、クラスタをすぐに導入せずにウィザードを実行してタスクを実行できますが、代わりに、あとでクラスタを導入できる構成ファイルが作成されます。これは、 IPI のデフォルトを変更する必要がある場合や、マルチテナンシーなどの他の用途のために環境内に同一のクラスタを複数導入する場合に非常に便利です。OpenShift 用にカスタマイズされたインストール構成の作成の詳細については、を参照してください link:https://docs.openshift.com/container-platform/4.7/installing/installing_vsphere/installing-vsphere-installer-provisioned-customizations.html["Red Hat OpenShift カスタマイズを使用して vSphere にクラスタをインストールします"^]。
