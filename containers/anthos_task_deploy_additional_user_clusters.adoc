---
sidebar: sidebar 
permalink: containers/anthos_task_deploy_additional_user_clusters.html 
summary: Anthos を使用すると、環境を拡張して複数のユーザクラスタを統合し、ワークロードをチーム間で分離できます。1 つの管理クラスタで最大 5 つのユーザクラスタをサポートでき、各ユーザクラスタで最大 25 個のノードをサポートできます。ユーザクラスタを導入環境に追加するには、このページに記載されている手順を実行します。 
keywords: VM, kubect1, kebeconfig 
---
= 9.Deploy Additional User Clusters, NetApp HCI with Anthos


[role="lead"]
Anthos を使用すると、環境を拡張して複数のユーザクラスタを統合し、ワークロードをチーム間で分離できます。1 つの管理クラスタで最大 5 つのユーザクラスタをサポートでき、各ユーザクラスタで最大 25 個のノードをサポートできます。

導入環境にユーザクラスタを追加するには、次の手順を実行します。

. 「 config.yaml 」ファイルを「 Anthos-dcluster02 - config.yaml 」という名前の新しいファイルにコピーします。
+
[listing]
----
ubuntu@Anthos-Admin-Workstation:~$ cp config.yaml anthos-cluster02-config.yaml
----
. 新しく作成したファイルを次のように編集します。
+
.. 既存の管理クラスタを参照するセクション（ # ）をコメントアウトします。
.. 「 usercluster 」セクションが表示されたら、次のフィールドを更新します。
+
... 「 bigip 」セクションのパーティション名を更新します。
... 「 vip 」セクションの「 controlplanvip 」と「 ingressvip 」の値を更新します。
... 「 clustername 」の値を更新します。
+
[listing]
----
 usercluster:
  # In-Cluster vCenter configuration
  vcenter:
    # If specified it overwrites the network field in global vcenter configuration
    network: ""
  # # The absolute or relative path to the yaml file to use for static IP allocation.
  # # Do not include if using DHCP
  # ipblockfilepath: ""
  # # Specify pre-defined nodeports if using "manual" load balancer mode
  # manuallbspec:
  #   ingresshttpnodeport: 30243
  #   ingresshttpsnodeport: 30879
  #   controlplanenodeport: 30562
  #   addonsnodeport: 0
  # Specify the already-existing partition and credentials to use with F5
  bigip:
    # To re-use credentials across clusters we recommend using YAML node anchors.
    # See https://yaml.org/spec/1.2/spec.html#id2785586
    credentials:
      address: "172.21.224.22"
      username: "admin"
      password: "NetApp!23"
    partition: "Anthos-Cluster02-Part"
    # # Optionally specify a pool name if using SNAT
    # snatpoolname: ""
  # The VIPs to use for load balancing
  vips:
    # Used to connect to the Kubernetes API
    controlplanevip: "10.63.172.108"
    # Shared by all services for ingress traffic
    ingressvip: "10.63.172.109"
    # # Used for admin cluster addons (needed for multi cluster features). Must be the same
    # # across clusters
    # addonsvip: ""
  # A unique name for this cluster
  clustername: "anthos-cluster02"
  # User cluster master nodes must have either 1 or 3 replicas
  masternode:
    cpus: 4
    memorymb: 8192
    # How many machines of this type to deploy
    replicas: 1
  # The number of worker nodes to deploy and their size. Min. 2 replicas
  workernode:
    cpus: 4
    memorymb: 8192
    # How many machines of this type to deploy
    replicas: 3
  # The Kubernetes service CIDR range for the cluster
  serviceiprange: 10.96.0.0/12
  # The Kubernetes pod CIDR range for the cluster
  podiprange: 192.168.0.0/16
----




. 次のコマンドを実行して構成ファイルを再度チェックし、構文エラーがないことを確認します。admin セクションを削除したので、 admin クラスタの「 kubeconfig 」という名前の「 kubeconfig 」ファイル（作業ディレクトリ内）を参照する必要があります。
+
[listing]
----
ubuntu@Anthos-Admin-Workstation:~$ gkectl check-config --config anthos-cluster02-config.yaml --kubeconfig kubeconfig
- Validation Category: Config Check
    - [SUCCESS] Config

- Validation Category: Docker Registry
    - [SUCCESS] gcr.io/gke-on-prem-release access

- Validation Category: vCenter
    - [SUCCESS] Credentials
    - [SUCCESS] Datacenter
    - [SUCCESS] Datastore
    - [FAILURE] Data Disk: vCenter data disk already exists
    - [SUCCESS] Resource Pool
    - [SUCCESS] Network

- Validation Category: F5 BIG-IP
    - [SUCCESS] Credentials
    - [SUCCESS] Partition

- Validation Category: Network Configuration
    - [SUCCESS] CIDR, VIP and static IP (availability and overlapping)

- Validation Category: VIPs
    - [SUCCESS] ping (availability)

- Validation Category: Node IPs
    - [SUCCESS] ping (availability)

Some validations FAILED or SKIPPED. Check report above.
----
. すべてのチェックが正常に実行される場合は、最初のクラスタ作成と非常によく似た方法で、 admin クラスタから「 kubeconfig 」ファイルを参照して、この新しいユーザクラスタを導入できます。
+
[listing]
----
ubuntu@Anthos-Admin-Workstation:~$ gkectl create cluster --config anthos-cluster02-config.yaml --kubeconfig kubeconfig
----
. 前の導入と同様に、このプロセスは数分実行され、 VM の取り込み時にリソースプールを監視することで、画面と vCenter で監視できます。完了すると、新しいユーザクラスタ（ 4 ノード）が表示されます。
+
image::new_user_cluster.PNG[新しいユーザクラスタを参照してください。]

. 展開したユーザクラスタに対してコマンドにアクセスして実行するには、 kubectl コマンドラインツールと、プロセスによって生成された「 kubeconfig 」ファイル（作業ディレクトリに格納されている）を使用します。
+
[listing]
----
ubuntu@Anthos-Admin-Workstation:~$ kubectl get nodes --kubeconfig anthos-cluster02-kubeconfig
NAME                                STATUS   ROLES    AGE     VERSION
anthos-cluster02-84744f5bd8-8rqk6   Ready    <none>   9m16s   v1.13.7-gke.20
anthos-cluster02-84744f5bd8-fl786   Ready    <none>   9m28s   v1.13.7-gke.20
anthos-cluster02-84744f5bd8-fnsmp   Ready    <none>   9m21s   v1.13.7-gke.20
----

