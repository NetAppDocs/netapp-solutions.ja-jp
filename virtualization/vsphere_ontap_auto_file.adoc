---
sidebar: sidebar 
permalink: virtualization/vsphere_ontap_auto_file.html 
keywords: vSphere, NFS, NFS4.1, NAS, ONTAP tools, VLAN, network interface 
summary: このページでは、 VMware vSphere 環境での NFS データストアのサポートについて説明します。 
---
= ONTAP を使用した、 vSphere の従来型ファイルストレージのプロビジョニング
:hardbreaks:
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/
:scriptsdir: ./../scripts/
:author: Suresh Thoppay, TME - Hybrid Cloud Solutions
:firstname: Suresh
:authorinitials: STT
:middlename: Thoppay,
:lastname: TME - Hybrid Cloud Solutions
:authors: Suresh Thoppay, TME - Hybrid Cloud Solutions


VMware vSphere では次の NFS プロトコルがサポートされていますが、どちらも ONTAP をサポートしています。

* link:vsphere_ontap_auto_file_nfs.html["NFS バージョン 3"]
* link:vsphere_ontap_auto_file_nfs41.html["NFS バージョン 4.1"]


vSphere に適した NFS バージョンを選択する方法については、を参照してください link:++https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.storage.doc/GUID-8A929FE4-1207-4CC5-A086-7016D73C328F.html++["この NFS クライアントバージョンの比較"]。

vSphere を使用すると、エンタープライズクラスの NFS アレイを使用して、 ESXi クラスタ内のすべてのノードへのデータストアへの同時アクセスを提供できます。データストアのセクションで説明したように、 vSphere で NFS を使用すると、使いやすさが向上し、ストレージ効率を可視化できるというメリットがあります。

vSphere で ONTAP NFS を使用する際に推奨されるベストプラクティスは次のとおりです。

* ONTAP クラスタ内の各ノードの各 SVM で、 1 つの論理インターフェイス（ LIF ）を使用します。データストアごとの LIF の過去の推奨事項は不要になりました。直接アクセス（同じノード上の LIF とデータストア）は最適ですが、パフォーマンスへの影響は一般に最小（マイクロ秒）であるため、間接アクセスを考慮しないでください。
* VMware は、 VMware Infrastructure 3 以降で NFSv3 をサポートしています。vSphere 6.0 では NFSv4.1 がサポートされるようになり、 Kerberos セキュリティなどの高度な機能が使用できるようになりました。NFSv3 ではクライアント側のロックが使用され、 NFSv4.1 ではサーバ側のロックが使用されます。ONTAP ボリュームは両方のプロトコルでエクスポートできますが、 ESXi は 1 つのプロトコルでしかマウントできません。この単一プロトコルのマウントにより、他の ESXi ホストが同じデータストアを別のバージョンでマウントすることができるわけではありません。すべてのホストが同じバージョン、つまり同じロック形式を使用するように、マウント時に使用するプロトコルバージョンを指定してください。NFS のバージョンをホスト間で混在させないでください。可能であれば、ホストプロファイルを使用して準拠しているかどうかを確認します
+
** NFSv3 と NFSv4.1 間ではデータストアが自動変換されないため、新しい NFSv4.1 データストアを作成し、 Storage vMotion を使用して新しいデータストアに VM を移行します。
** に記載されている NFS v4.1 と相互運用性に関する表の注を参照してください https://mysupport.netapp.com/matrix/["NetApp Interoperability Matrix Tool で確認できます"^] をサポートするには、特定の ESXi パッチレベルが必要です。


* NFS エクスポートポリシーは、 vSphere ホストによるアクセスの制御に使用されます。複数のボリューム（データストア）で 1 つのポリシーを使用できます。NFSv3 では、 ESXi で sys （ UNIX ）セキュリティ形式が使用され、 VM を実行するためにルートマウントオプションが必要となります。ONTAP では、このオプションはスーパーユーザと呼ばれます。スーパーユーザオプションを使用する場合は、匿名ユーザ ID を指定する必要はありません。-anon` と --allow-suid に異なる値を持つエクスポートポリシールールは、 ONTAP 原因ツールで SVM の検出に関する問題が発生する可能性があることに注意してください。ポリシーの例を次に示します。
+
** Access Protocol ： nfs3
** クライアント一致仕様： 192.168.42.21
** RO アクセスルール： sys
** RW アクセスルール： sys
** 匿名 UID ：
** superuser ： sys


* NetApp NFS Plug-in for VMware VAAI を使用する場合、エクスポートポリシールールの作成時または変更時にプロトコルを「 nfs 」に設定する必要があります。VAAI コピーオフロードが機能するためには NFSv4 プロトコルが必要です。プロトコルを「 nfs 」に指定すると、 NFSv3 バージョンと NFSv4 バージョンの両方が自動的に組み込まれます。
* NFS データストアのボリュームは SVM のルートボリュームからジャンクションされるため、 ESXi がデータストアボリュームに移動してマウントするためにはルートボリュームへのアクセス権も必要となります。ルートボリューム、およびデータストアボリュームのジャンクションがネストされているその他のボリュームのエクスポートポリシーには、 ESXi サーバに読み取り専用アクセスを許可するルールが含まれている必要があります。VAAI プラグインを使用したルートボリュームのポリシーの例を次に示します。
+
** Access Protocol の略。nfs （ nfs3 と nfs4 の両方を含む）
** クライアント一致仕様。192.168.42.21
** RO アクセスルール。システム
** RW アクセスルール：なし（ルートボリュームに最適なセキュリティ）
** 匿名 UID の形式です。
** スーパーユーザ：sys （ VAAI を使用するルートボリュームでも必要）


* VMware vSphere 用の ONTAP ツール（最も重要なベストプラクティス）を使用：
+
** VMware vSphere 用の ONTAP ツールを使用してデータストアをプロビジョニングすると、エクスポートポリシーの自動管理が簡易化されます。
** プラグインを使用して VMware クラスタ用のデータストアを作成するときは、単一の ESX サーバではなくクラスタを選択します。これにより、データストアがクラスタ内のすべてのホストに自動的にマウントされます。
** プラグインのマウント機能を使用して、既存のデータストアを新しいサーバに適用します。
** VMware vSphere 用の ONTAP ツールを使用しない場合は、すべてのサーバ、または追加のアクセス制御が必要なサーバクラスタごとに、 1 つのエクスポートポリシーを使用します。


* ONTAP にはフレキシブルボリュームのネームスペース構造が用意されており、ジャンクションを使用してボリュームをツリーにまとめることができますが、このアプローチは vSphere には価値がありません。ストレージのネームスペース階層に関係なく、データストアのルートに各 VM 用のディレクトリが作成されます。そのため、単に SVM のルートボリュームに vSphere のボリュームのジャンクションパスをマウントすることがベストプラクティスです。これは、 VMware vSphere 用の ONTAP ツールでデータストアをプロビジョニングする方法です。ジャンクションパスがネストされていないと、ルートボリューム以外のボリュームに依存しているボリュームがないこと、またボリュームをオフラインにするか破棄するかによって意図的に他のボリュームへのパスに影響が及ぶこともありません。
* NFS データストアの NTFS パーティションのブロックサイズは 4K で十分です。次の図は、 vSphere ホストから ONTAP NFS データストアへの接続を示しています。


image:vsphere_ontap_image3.png["エラー：グラフィックイメージがありません"]

次の表に、 NFS のバージョンとサポートされる機能を示します。

|===
| vSphere の機能 | NFSv3 | NFSv4.1 


| vMotion と Storage vMotion | はい。 | はい。 


| 高可用性 | はい。 | はい。 


| フォールトトレランス | はい。 | はい。 


| DRS | はい。 | はい。 


| ホストプロファイル | はい。 | はい。 


| Storage DRS | はい。 | いいえ 


| ストレージ I/O の制御 | はい。 | いいえ 


| SRM の場合 | はい。 | いいえ 


| 仮想ボリューム | はい。 | いいえ 


| ハードウェアアクセラレーション（ VAAI ） | はい。 | ○（ vSphere 6.5 以降、 NetApp VAAI プラグイン 1.1.2 ） 


| Kerberos 認証 | いいえ | ○（ vSphere 6.5 以降で拡張して、 AES 、 krb5i ） 


| マルチパスのサポート | いいえ | × （ ESXi 6.5 以降ではセッショントランキングを通じてサポートされ、 ONTAP では pNFS を通じてサポートされます） 
|===