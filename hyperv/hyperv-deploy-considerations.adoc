---
sidebar: sidebar 
permalink: hyperv/hyperv-deploy-considerations.html 
keywords: hyperv, hyper-v, deploy, netapp, virtualization, consideration 
summary: 解決策には、Hyper-VをNetAppストレージに導入するために必要な手順が記載されている 
---
= 『Deploying Microsoft Hyper-V on NetApp Storage』：「Considerations」
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
この手順は、Hyper-V環境でアプリケーション、サービス、ワークロードが効果的に動作することを確認するために不可欠です。互換性チェックには、オペレーティングシステムのバージョン、Windowsサーバのバージョン、アプリケーションの依存関係、データベースシステム、および既存の環境に存在する特定の構成やカスタマイズが含まれている必要があります。



== ストレージの適切なサイジング

ワークロードを導入する前、または既存のハイパーバイザーから移行する前に、必要なパフォーマンスを満たすようにワークロードがサイジングされていることを確認してください。これは、個 々 のVMのパフォーマンスデータを収集して、CPU（使用済み/プロビジョニング済み）、メモリ（使用済み/プロビジョニング済み）、ストレージ（プロビジョニング済み/利用済み）、ネットワークスループット、レイテンシ、および読み取り/書き込みIOPS、スループット、ブロックサイズの集計を行うことで簡単に実現できます。これらのパラメータは、導入を成功させるため、およびストレージアレイとワークロードホストのサイズを正しく設定するためには必須です。

*注*：Hyper-Vおよび関連するワークロードのストレージをサイジングする際には、IOPSと容量を計画してください。

*注*：I/O負荷の高いVMや、大量のリソースと容量を必要とするVMの場合は、OSとデータディスクを分離します。オペレーティングシステムやアプリケーションのバイナリは頻繁に変更されず、ボリュームのクラッシュ整合性も許容されます。

*注*：VHDよりも高性能なデータディスクには、ゲスト接続ストレージ（ゲスト内）を使用します。これは、クローン作成プロセスを簡単にするのにも役立ちます。



== 仮想マシンのパフォーマンスの向上

最適なパフォーマンスを得るには、適切なRAMとvCPUの容量を選択し、複数のディスクを単一の仮想SCSIコントローラに接続します。導入時の仮想ディスクの主な選択肢として固定VHDxを使用することが引き続き推奨されます。また、どのタイプのVHDX仮想ディスクの使用にも制限はありません。

*注*：使用されない不要な役割をWindows Serverにインストールしないでください。

*注*：SCSIコントローラからVMをロードできる仮想マシンの世代としてGen2を選択します。ブートレベルはVMBusおよびVSP/VSCアーキテクチャに基づいているため、VMの全体的なパフォーマンスが大幅に向上します。

*注*：VMのパフォーマンスに悪影響を及ぼすため、チェックポイントを頻繁に作成することは避けてください。



== SMB3.0の設計と検討事項

SMB 3.0ファイル共有をHyper-V用の共有ストレージとして使用できます。ONTAPでは、Hyper-VのSMB共有を介したノンストップオペレーションがサポートされます。Hyper-Vでは、SMBファイル共有を使用して、構成、スナップショット、仮想ハードディスク（VHD）ファイルなどの仮想マシンファイルを格納できます。Hyper-VのSMB3.0ベースの共有には専用のONTAP CIFS SVMを使用します。仮想マシンファイルの格納に使用するボリュームは、NTFSセキュリティ形式のボリュームで作成する必要があります。10GBのネットワークがある場合は、Hyper-VホストとNetAppアレイの間の接続を推奨します。1GBのネットワーク接続の場合、NetAppでは、複数の1GBポートで構成されるインターフェイスグループを作成することを推奨します。SMBマルチチャネルを提供する各NICを専用のIPサブネットに接続し、各サブネットがクライアントとサーバの間に単一のパスを提供するようにします。

*キーポイント*

* ONTAP SVMでのSMBマルチチャネルの有効化
* ONTAP CIFS SVMには、クラスタ内の各ノードに少なくとも1つのデータLIFが必要です。
* 使用する共有にcontinuously-availableプロパティが設定されている必要があります。
* ONTAP Oneは、すべてのAFF（AシリーズおよびCシリーズ）、All-SAN Array（ASA）、およびFASシステムに含まれるようになりました。したがって、個別のライセンスは必要ありません。
* 共有VHDxの場合は、ゲスト接続iSCSI LUNを使用


*注*：ODXはサポートされており、複数のプロトコルに対応しています。ファイル共有とiSCSIまたはFCP接続LUNの間でデータをコピーする場合も、ODXが使用されます。

*注*：クラスタ内のノードの時間設定は、それに応じて設定する必要があります。NetApp CIFSサーバがWindows Active Directory（AD）ドメインに参加する必要がある場合は、ネットワークタイムプロトコル（NTP）を使用する必要があります。

*注*：大きなMTU値は、CIFSサーバを介して有効にする必要があります。パケットサイズが小さいと、パフォーマンスが低下する可能性があります。



== SMBボリュームのプロビジョニング

. Storage Virtual Machine（SVM）で必要なCIFSサーバオプションが有効になっていることを確認する
. 次のオプションをtrueに設定する必要があります。smb2-enabled smb3-enabled copy-offload-enabled shadowcopy-enabled is-multichannel-enabled is-large-mtu-enabled
+
image:hyperv-deploy-image03.png["SMBカラム設定の画像"]

. Storage Virtual Machine（SVM）にNTFSデータボリュームを作成し、Hyper-Vで使用する継続的可用性を備えた共有を設定する
+
image:hyperv-deploy-image04.png["NTFSデータボリューム設定のイメージ"]

+
*注*：Hyper-V over SMBのノンストップオペレーションは、この構成で使用するボリュームをNTFSセキュリティ形式のボリュームとして作成しないかぎり、正しく機能しません。

. 継続的可用性を有効にし、共有のNTFS権限を設定して、Hyper-Vノードを完全に制御できるようにします。
+
image:hyperv-deploy-image05.png["NTFS権限設定の画像"]



ベストプラクティスの詳細なガイダンスについては、を参照してください。 link:https://docs.netapp.com/us-en/ontap-apps-dbs/microsoft/win_overview.html["Hyper-Vの導入ガイドラインとベストプラクティス"]。

追加情報については、を参照してください。 link:https://docs.netapp.com/us-en/ontap/smb-hyper-v-sql/server-volume-requirements-hyper-v-concept.html["Hyper-V over SMB 用の SMB サーバとボリュームの要件
"]。



== ブロックプロトコルの設計と考慮事項

*キーポイント*

* ホストでマルチパス（MPIO）を使用して、複数のパスを管理します。データ移動処理を容易にするため、または追加のI/Oリソースを活用するために、必要に応じてパスを追加します。ただし、ホストOSがサポートできるパスの最大数を超えないようにしてください。
* LUNにアクセスするホストにHost Utilities Kitをインストールします。
* 少なくとも8つのボリュームを作成します。


*注*：ボリュームごとに1つのLUNを使用するため、LUNとCSVの比率が1：1にマッピングされます。

* SVMには、iSCSIまたはファイバチャネルを使用してデータを提供するすべてのストレージコントローラ上のイーサネットネットワークまたはファイバチャネルファブリックごとに1つのLIFが必要です。
* FCPまたはiSCSIを使用してデータを提供するSVMには、SVM管理インターフェイスが必要です。




== iSCSIボリュームのプロビジョニング

iSCSIボリュームをプロビジョニングするには、次の前提条件を満たしていることを確認してください。

* Storage Virtual Machine（SVM）でiSCSIプロトコルを有効にし、適切な論理インターフェイス（LIF）を作成しておく必要があります。
* 指定したアグリゲートには、LUNを格納できるだけの十分な空きスペースが必要です。


*注*：デフォルトでは、ONTAPは選択的LUNマップ（SLM）を使用して、LUNを所有するノードとそのハイアベイラビリティ（HA）パートナーのパス経由でのみLUNにアクセスできるようにします。

* LUNがクラスタ内の別のノードに移動された場合にLUNを使用できるように、すべてのノードのすべてのiSCSI LIFを設定します。


* 手順 *

. System Managerを使用して[LUN]ウィンドウに移動します（ONTAP CLIも同じ処理に使用できます）。
. Create をクリックします。 .
. 指定したLUNを作成するSVMを参照して選択し、LUN作成ウィザードが表示されます。
. [General Properties]ページで、Hyper-V仮想マシンの仮想ハードディスク（VHD）を含むLUNの場合は[Hyper-V]を選択します。
+
image:hyperv-deploy-image06.png["Hyper-V LUNを作成するための[General Properties]ページの画像"]

. <[More options]をクリックします。[LUN Container]ページで、既存のFlexVolボリュームを選択します。選択しないと、新しいボリュームが作成されます。
. <その他のオプションをクリック>[Initiators Mapping]ページで[Add Initiator Group]をクリックし、[General]タブで必要な情報を入力し、[Initiators]タブでホストのiSCSIイニシエータノード名を入力します。
. 詳細を確認し、[終了]をクリックしてウィザードを完了します。


LUNが作成されたら、フェイルオーバークラスタマネージャに移動します。ディスクをCSVに追加するには、そのディスクをクラスタのAvailable Storageグループに追加し（まだ追加されていない場合）、そのディスクをクラスタのCSVに追加する必要があります。

*注*：CSV機能は、フェールオーバークラスタリングでデフォルトで有効になっています。

*使用可能なストレージへのディスクの追加：*

. フェイルオーバークラスタマネージャのコンソールツリーで、クラスタの名前を展開し、[Storage]を展開します。
. [Disks]を右クリックし、[Add Disk]を選択します。フェイルオーバークラスタで使用するために追加できるディスクのリストが表示されます。
. 追加するディスクを選択し、[OK]を選択します。
. これで、ディスクがAvailable Storageグループに割り当てられました。
. 完了したら、[Available Storage]に割り当てたディスクを選択し、選択したディスクを右クリックして[Add to Cluster Shared Volumes]を選択します。
+
image:hyperv-deploy-image07.png["[Add to Cluster Shared Volumes]インターフェイスの画像"]

. これで、ディスクがクラスタ内のクラスタ共有ボリュームグループに割り当てられました。ディスクは、%SystemDrive%ClusterStorageフォルダの下の番号付きボリューム（マウントポイント）として各クラスタノードに公開されます。ボリュームがCSVFSファイルシステムに表示されます。


追加情報については、を参照してください。 link:https://learn.microsoft.com/en-us/windows-server/failover-clustering/failover-cluster-csvs#add-a-disk-to-csv-on-a-failover-cluster["フェイルオーバークラスタでのクラスタ共有ボリュームの使用"]。

*高可用性仮想マシンの作成：*

高可用性仮想マシンを作成するには、次の手順を実行します。

. フェイルオーバークラスタマネージャで、目的のクラスタを選択または指定します。クラスタの下のコンソールツリーが展開されていることを確認します。
. [Roles]をクリックします。
. [操作]ペインで、[仮想マシン]をクリックし、[新しい仮想マシン]をクリックします。[New Virtual Machine Wizard]が表示されます。次へをクリックします。
. [Specify Name and Location]ページで、仮想マシンの名前（nimdemoなど）を指定します。[Store the virtual machine in a different location]をクリックして完全パスを入力するか、[Browse]をクリックして共有ストレージに移動します。
. 物理ネットワークアダプタに関連付けられた仮想スイッチにメモリを割り当て、ネットワークアダプタを設定します。
. [Connect Virtual Hard Disk]ページで、[Create a virtual hard disk]をクリックします。
. [Installation Options]ページで、[Install an operating system from a boot CD/DVD-ROM]をクリックします。[メディア]で、メディアの場所を指定し、[完了]をクリックします。
. 仮想マシンが作成されます。フェイルオーバークラスタマネージャの高可用性ウィザードにより、仮想マシンの高可用性が自動的に設定されます。




== ODX機能を使用した仮想ディスクの高速プロビジョニング

ONTAPのODX機能を使用すると、ONTAPストレージシステムでホストされているマスターVHDXファイルをコピーするだけで、マスターVHDXのコピーを作成できます。ODX対応のコピーではネットワーク回線にデータが配置されないため、NetAppストレージ側でコピープロセスが実行されるため、最大で6~8倍の時間が短縮されます。高速プロビジョニングの一般的な考慮事項には、ファイル共有に格納されたマスターsysprepイメージや、Hyper-Vホストマシンによって開始される通常のコピープロセスなどがあります。

*注*：ONTAPでは、SMBプロトコルとSANプロトコルの両方でODXがサポートされます。

*注*：Hyper-VでのODXコピーオフロードのパススルーのユースケースを利用するには、ゲストオペレーティングシステムでODXがサポートされている必要があります。また、ゲストオペレーティングシステムのディスクは、ODXをサポートするストレージ（SMBまたはSAN）から作成されたSCSIディスクである必要があります。ゲストオペレーティングシステムのディスクが IDE ディスクの場合、 ODX のパススルーはサポートされません。



== パフォーマンスの最適化

CSVあたりの推奨VM数は主観的なものですが、CSVまたはSMBの各ボリュームに配置できるVMの最適数は、さまざまな要因によって決まります。ほとんどの管理者は容量のみを考慮しますが、VHDxに送信される同時I/Oの量は、全体的なパフォーマンスの最も重要な要因の1つです。パフォーマンスを制御する最も簡単な方法は、CSVまたは共有ごとに配置される仮想マシンの数を規制することです。仮想マシンの同時I/OパターンからCSVまたは共有に大量のトラフィックが送信されると、ディスクキューがいっぱいになり、レイテンシが高くなります。



== SMBボリュームとCSVのサイジング

ボトルネックを回避するために解決策のサイズがエンドツーエンドで適切に設定されていることを確認し、Hyper-V VMストレージ用にボリュームを作成する場合は、必要以上のサイズのボリュームを作成することを推奨します。ボリュームのサイズを適正化することで、CSV上に誤って多数の仮想マシンが配置されるのを防ぎ、リソース競合の可能性を低減できます。各クラスタ共有ボリューム（CSV）では、1つまたは複数のVMがサポートされます。CSVに配置するVMの数は、ワークロードやビジネスの設定、およびSnapshotやレプリケーションなどのONTAPストレージ機能の使用方法によって決まります。ほとんどの導入シナリオでは、複数のVMをCSVに配置することを推奨します。パフォーマンスとデータ保護の要件に合わせて、特定のユースケースに合わせてこのアプローチを調整してください。

ボリュームとVHDxのサイズは簡単に拡張できるため、VMで追加の容量が必要になった場合でも、CSVのサイズを必要以上に設定する必要はありません。Diskpartを使用してCSVサイズを拡張することも、新しいCSVを作成して必要なVMを新しいCSVに移行することもできます。最適なパフォーマンスを得るためには、中間的な手段としてCSVのサイズを増やすのではなく、CSVの数を増やすことを推奨します。



== データ移行

現在の市場状況で最も一般的なユースケースの1つは、移行です。VMMファブリックまたはその他のサードパーティの移行ツールを使用して、VMを移行できます。これらのツールでは、ホストレベルのコピーを使用して、ソースプラットフォームからデスティネーションプラットフォームにデータを移動します。移行の対象となる仮想マシンの数によっては、時間がかかる場合があります。

このようなシナリオでONTAPを使用すると、ホストベースの移行プロセスよりも迅速に移行できます。また、ONTAPでは、ハイパーバイザー間でVMを迅速に移行できます（この場合はESXiからHyper-V）。NetAppストレージでは、任意のサイズのVMDKを数秒でVHDxに変換できます。これがPowerShellの方法です。NetApp FlexClone®テクノロジを活用して、VMのハードディスクを迅速に変換します。また、ターゲットVMとデスティネーションVMの作成と設定も行います。

このプロセスにより、ダウンタイムが最小限に抑えられ、ビジネスの生産性が向上します。また、ライセンスコスト、ロックイン、単一ベンダーへのコミットメントを削減することで、選択肢と柔軟性を提供します。これは、VMのライセンスコストを最適化し、IT予算を拡大したいと考えている組織にとっても有益です。

次のビデオでは、VMware ESXからHyper-Vに仮想マシンを移行するプロセスについて説明します。

.ESXからHyper-Vへのゼロタッチ移行
video::f4bd0e96-9517-465a-be53-b16d00e305fe[panopto]
追加情報でFlexCloneとPowerShellを使用した移行については、を参照してください。 link:hyperv-deploy-script.html["イコウヨウノPowerShellスクリフト"]。
